{"version":3,"sources":["assets\\frames\\net\\pomelo\\pomelo-client.js"],"names":["JS_WS_CLIENT_TYPE","JS_WS_CLIENT_VERSION","Proctocol","require","Package","Protocol","Message","window","sys","localStorage","RES_OK","RES_FAIL","RES_OLD_CLIENT","Object","create","o","F","prototype","root","pomelo","socket","reqId","handlers","routeMap","heartbeatInterval","heartbeatTimeout","nextHeartbeatTimeout","gapThreshold","heartbeatId","heartbeatTimeoutId","handshakeCallback","decode","encode","useCrypto","handshakeBuffer","type","version","connectcb","debug","msgcb","init","params","host","port","url","toLowerCase","indexOf","user","initWebSocket","onopen","event","obj","TYPE_HANDSHAKE","strencode","JSON","stringify","send","onmessage","processPackage","data","Date","now","onerror","cc","error","arguments","onclose","pemUrl","raw","console","log","loader","md5Pipe","transformURL","WebSocket","binaryType","clearListener","disconnect","close","clearTimeout","request","route","msg","sendMessage","notify","getState","readyState","TYPE_REQUEST","TYPE_NOTIFY","protos","client","protobuf","compressRoute","dict","packet","TYPE_DATA","buffer","handler","heartbeat","TYPE_HEARTBEAT","setTimeout","heartbeatTimeoutCb","gap","handshake","parse","strdecode","code","handshakeInit","TYPE_HANDSHAKE_ACK","onData","id","body","deCompose","processMessage","onKick","TYPE_KICK","msgs","Array","isArray","i","length","processMessageBatch","l","server","abbrs","initData","encoderProtos","decoderProtos","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["(function () {\r\n    var JS_WS_CLIENT_TYPE = 'js-websocket';\r\n    var JS_WS_CLIENT_VERSION = '0.0.1';\r\n\r\n    var Proctocol = require(\"protocol\");\r\n    var Package = Protocol.Package;\r\n    var Message = Protocol.Message;\r\n\r\n    if (typeof (window) != \"undefined\" && typeof (sys) != 'undefined' && sys.localStorage) {\r\n        window.localStorage = sys.localStorage;\r\n    }\r\n\r\n    var RES_OK = 200;\r\n    var RES_FAIL = 500;\r\n    var RES_OLD_CLIENT = 501;\r\n\r\n    if (typeof Object.create !== 'function') {\r\n        Object.create = function (o) {\r\n            function F() { }\r\n            F.prototype = o;\r\n            return new F();\r\n        };\r\n    }\r\n\r\n    var root = window;\r\n    var pomelo = {};\r\n    root.pomelo = pomelo;\r\n    var socket = null;\r\n    var reqId = 0;\r\n    var handlers = {};\r\n    //Map from request id to route\r\n    var routeMap = {};\r\n\r\n    var heartbeatInterval = 0;\r\n    var heartbeatTimeout = 0;\r\n    var nextHeartbeatTimeout = 0;\r\n    var gapThreshold = 100;   // heartbeat gap threashold\r\n    var heartbeatId = null;\r\n    var heartbeatTimeoutId = null;\r\n\r\n    var handshakeCallback = null;\r\n\r\n    var decode = null;\r\n    var encode = null;\r\n\r\n    var useCrypto;\r\n\r\n    var handshakeBuffer = {\r\n        'sys': {\r\n            type: JS_WS_CLIENT_TYPE,\r\n            version: JS_WS_CLIENT_VERSION\r\n        },\r\n        'user': {\r\n        }\r\n    };\r\n\r\n\r\n    var connectcb = null;\r\n    var debug = false;\r\n    var msgcb = null;\r\n\r\n\r\n    pomelo.init = function (params) {\r\n\r\n        var host = params.host;\r\n        var port = params.port;\r\n        connectcb = params.connectcb;\r\n        debug = params.debug;\r\n        msgcb = params.msgcb;\r\n        var url = \"\";\r\n        if (host.toLowerCase().indexOf(\"ws://\") >= 0 || host.toLowerCase().indexOf(\"wss://\") >= 0) url = host;\r\n        else url = 'ws://' + host;\r\n\r\n        if (port) {\r\n            url += ':' + port;\r\n        }\r\n\r\n        handshakeBuffer.user = params.user;\r\n        handshakeCallback = params.handshakeCallback;\r\n        initWebSocket(url);\r\n    };\r\n\r\n    var initWebSocket = function (url) {\r\n        var onopen = function (event) {\r\n            var obj = Package.encode(Package.TYPE_HANDSHAKE, Protocol.strencode(JSON.stringify(handshakeBuffer)));\r\n            send(obj);\r\n        };\r\n        var onmessage = function (event) {\r\n            processPackage(Package.decode(event.data));\r\n            // new package arrived, update the heartbeat timeout\r\n            if (heartbeatTimeout) {\r\n                nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\r\n            }\r\n        };\r\n        var onerror = function (event) {\r\n            if (connectcb) {\r\n                connectcb('io-error', event);\r\n            }\r\n            cc.error('socket error: ', JSON.stringify(arguments, null, 2));\r\n        };\r\n        var onclose = function (event) {\r\n            if (connectcb) {\r\n                connectcb('close', event);\r\n                connectcb('disconnect', event);\r\n            }\r\n            cc.error('socket close: ', JSON.stringify(arguments, null, 2));\r\n        };\r\n        // socket = new WebSocket(url);\r\n        //采用論壇中的方法支持 wss  by root 20190921\r\n        let pemUrl = cc.url.raw(\"resources/cacert.pem\");\r\n        console.log(\"pemUrl:\" + pemUrl);\r\n        if (cc.loader.md5Pipe) {\r\n            pemUrl = cc.loader.md5Pipe.transformURL(pemUrl);\r\n        }\r\n        console.log(\"transformURL(pemUrl):\" + pemUrl);\r\n        socket = new WebSocket(url, null, pemUrl);\r\n\r\n        socket.binaryType = 'arraybuffer';\r\n        socket.onopen = onopen;\r\n        socket.onmessage = onmessage;\r\n        socket.onerror = onerror;\r\n        socket.onclose = onclose;\r\n    };\r\n    pomelo.clearListener = function () {\r\n        connectcb = function () { };\r\n        msgcb = function () { };\r\n    }\r\n    pomelo.disconnect = function () {\r\n        if (socket) {\r\n            if (socket.disconnect) socket.disconnect();\r\n            if (socket.close) socket.close();\r\n            socket = null;\r\n        }\r\n\r\n        if (heartbeatId) {\r\n            clearTimeout(heartbeatId);\r\n            heartbeatId = null;\r\n        }\r\n        if (heartbeatTimeoutId) {\r\n            clearTimeout(heartbeatTimeoutId);\r\n            heartbeatTimeoutId = null;\r\n        }\r\n    };\r\n\r\n    pomelo.request = function (route, msg) {\r\n\r\n        if (!route) {\r\n            return;\r\n        }\r\n\r\n        reqId++;\r\n        sendMessage(reqId, route, msg);\r\n        routeMap[reqId] = route;\r\n        console.log(\"routeMap=\", routeMap)\r\n    };\r\n\r\n    pomelo.notify = function (route, msg) {\r\n        msg = msg || {};\r\n        sendMessage(0, route, msg);\r\n    };\r\n\r\n    pomelo.getState = function () {\r\n        return (!socket || socket.readyState != 1) ? false : true;\r\n    }\r\n\r\n    var sendMessage = function (reqId, route, msg) {\r\n        var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\r\n\r\n        //compress message by protobuf\r\n        var protos = !!pomelo.data.protos ? pomelo.data.protos.client : {};\r\n        if (!!protos[route]) {\r\n            msg = protobuf.encode(route, msg);\r\n        } else {\r\n            msg = Protocol.strencode(JSON.stringify(msg));\r\n        }\r\n\r\n\r\n        var compressRoute = 0;\r\n        if (pomelo.dict && pomelo.dict[route]) {\r\n            route = pomelo.dict[route];\r\n            compressRoute = 1;\r\n        }\r\n\r\n        msg = Message.encode(reqId, type, compressRoute, route, msg);\r\n        var packet = Package.encode(Package.TYPE_DATA, msg);\r\n        send(packet);\r\n    };\r\n\r\n    var send = function (packet) {\r\n        if (!socket || !socket.send) return console.error(\"pomelo socket fractured!!\");\r\n        socket.send(packet.buffer);\r\n    };\r\n\r\n\r\n    var handler = {};\r\n\r\n    var heartbeat = function (data) {\r\n        if (!heartbeatInterval) {\r\n            // no heartbeat\r\n            return;\r\n        }\r\n\r\n        var obj = Package.encode(Package.TYPE_HEARTBEAT);\r\n        if (heartbeatTimeoutId) {\r\n            clearTimeout(heartbeatTimeoutId);\r\n            heartbeatTimeoutId = null;\r\n        }\r\n\r\n        if (heartbeatId) {\r\n            // already in a heartbeat interval\r\n            return;\r\n        }\r\n\r\n        heartbeatId = setTimeout(function () {\r\n            heartbeatId = null;\r\n            send(obj);\r\n\r\n            nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\r\n            heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, heartbeatTimeout);\r\n        }, heartbeatInterval);\r\n    };\r\n\r\n    var heartbeatTimeoutCb = function () {\r\n        var gap = nextHeartbeatTimeout - Date.now();\r\n        if (gap > gapThreshold) {\r\n            heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, gap);\r\n        } else {\r\n            cc.error('server heartbeat timeout');\r\n            connectcb('heartbeat timeout');\r\n            pomelo.disconnect();\r\n        }\r\n    };\r\n\r\n    var handshake = function (data) {\r\n        data = JSON.parse(Protocol.strdecode(data));\r\n        if (data.code === RES_OLD_CLIENT) {\r\n            connectcb('error', 'client version not fullfill');\r\n            return;\r\n        }\r\n\r\n        if (data.code !== RES_OK) {\r\n            connectcb('error', 'handshake fail');\r\n            return;\r\n        }\r\n\r\n        handshakeInit(data);\r\n\r\n        var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\r\n        send(obj);\r\n\r\n        connectcb(\"connect\")\r\n    };\r\n\r\n    var onData = function (data) {\r\n        //probuff decode\r\n        var msg = Message.decode(data);\r\n\r\n        if (msg.id > 0) {\r\n            msg.route = routeMap[msg.id];\r\n            delete routeMap[msg.id];\r\n            if (!msg.route) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        msg.body = deCompose(msg);\r\n\r\n        processMessage(pomelo, msg);\r\n    };\r\n\r\n    var onKick = function (data) {\r\n        data = JSON.parse(Protocol.strdecode(data));\r\n        connectcb('onKick', data);\r\n    };\r\n\r\n    handlers[Package.TYPE_HANDSHAKE] = handshake;\r\n    handlers[Package.TYPE_HEARTBEAT] = heartbeat;\r\n    handlers[Package.TYPE_DATA] = onData;\r\n    handlers[Package.TYPE_KICK] = onKick;\r\n\r\n    var processPackage = function (msgs) {\r\n        if (Array.isArray(msgs)) {\r\n            for (var i = 0; i < msgs.length; i++) {\r\n                var msg = msgs[i];\r\n                handlers[msg.type](msg.body);\r\n            }\r\n        } else {\r\n            handlers[msgs.type](msgs.body);\r\n        }\r\n    };\r\n\r\n    var processMessage = function (pomelo, msg) {\r\n        let code = null;\r\n        if (msg.body) {\r\n            code = msg.body.code;\r\n        }\r\n        msgcb(msg.route, code, msg.body);\r\n        return;\r\n    };\r\n\r\n    var processMessageBatch = function (pomelo, msgs) {\r\n        for (var i = 0, l = msgs.length; i < l; i++) {\r\n            processMessage(pomelo, msgs[i]);\r\n        }\r\n    };\r\n\r\n    var deCompose = function (msg) {\r\n        var protos = !!pomelo.data.protos ? pomelo.data.protos.server : {};\r\n        var abbrs = pomelo.data.abbrs;\r\n        var route = msg.route;\r\n\r\n        //Decompose route from dict\r\n        if (msg.compressRoute) {\r\n            if (!abbrs[route]) {\r\n                return {};\r\n            }\r\n\r\n            route = msg.route = abbrs[route];\r\n        }\r\n        if (!!protos[route]) {\r\n            return protobuf.decode(route, msg.body);\r\n        } else {\r\n            return JSON.parse(Protocol.strdecode(msg.body));\r\n        }\r\n\r\n        return msg;\r\n    };\r\n\r\n    var handshakeInit = function (data) {\r\n        if (data.sys && data.sys.heartbeat) {\r\n            heartbeatInterval = data.sys.heartbeat * 1000;   // heartbeat interval\r\n            heartbeatTimeout = heartbeatInterval * 2;        // max heartbeat timeout\r\n        } else {\r\n            heartbeatInterval = 0;\r\n            heartbeatTimeout = 0;\r\n        }\r\n\r\n        initData(data);\r\n\r\n        if (typeof handshakeCallback === 'function') {\r\n            handshakeCallback(data.user);\r\n        }\r\n    };\r\n\r\n    //Initilize data used in pomelo client\r\n    var initData = function (data) {\r\n        if (!data || !data.sys) {\r\n            return;\r\n        }\r\n        pomelo.data = pomelo.data || {};\r\n        var dict = data.sys.dict;\r\n        var protos = data.sys.protos;\r\n\r\n        //Init compress dict\r\n        if (dict) {\r\n            pomelo.data.dict = dict;\r\n            pomelo.data.abbrs = {};\r\n\r\n            for (var route in dict) {\r\n                pomelo.data.abbrs[dict[route]] = route;\r\n            }\r\n        }\r\n\r\n        //Init protobuf protos\r\n        if (protos) {\r\n            pomelo.data.protos = {\r\n                server: protos.server || {},\r\n                client: protos.client || {}\r\n            };\r\n            if (!!protobuf) {\r\n                protobuf.init({ encoderProtos: protos.client, decoderProtos: protos.server });\r\n            }\r\n        }\r\n    };\r\n\r\n    module.exports = pomelo;\r\n})();\r\n"]}