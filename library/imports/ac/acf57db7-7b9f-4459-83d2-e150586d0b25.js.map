{"version":3,"sources":["assets\\frames\\base\\resloader.js"],"names":["g_instance","ccloader","cc","loader","isChildClassOf","js","parseDepends","key","parsed","item","getItem","depends","dependKeys","i","length","depend","has","add","getNodesDepends","nodes","ret","Set","visitNode","node","excludeMap","_components","visitComponent","_children","comp","props","Object","getOwnPropertyNames","value","Array","isArray","j","val","RawAsset","visitAsset","constructor","keys","asset","_uuid","_getReferenceKey","CacheInfo","refs","uses","resloader","_resMap","Map","_sceneDepends","_lastScene","sys","isNative","scene","director","getScene","_cacheScene","on","Director","EVENT_BEFORE_SCENE_LAUNCH","resArgs","_makeLoadResArgs","apply","arguments","finishCallback","error","resource","console","log","size","_finishItem","url","type","use","onCompleted","res","getRes","uuid","_getResUuid","loadRes","onProgess","load","getResCount","_makeReleaseResArgs","_getResItem","warn","cacheInfo","_getCacheInfo","id","_release","itemUrl","depKey","depItem","_cache","release","ref","set","get","refKey","_buildDepend","assetType","_cacheItem","urls","persistDepends","_getPersistNodeList","undefined","useKey","name","newUseKey","_cacheSceneDepend","_releaseSceneDepend","_sceneUseKey","game","persistNodeList","_persistRootNodes","map","x","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["let g_instance = null;\r\nlet ccloader = cc.loader;\r\n\r\n// 兼容性处理\r\nlet isChildClassOf = cc.js[\"isChildClassOf\"]\r\nif (!isChildClassOf) {\r\n    isChildClassOf = cc[\"isChildClassOf\"];\r\n}\r\n\r\nfunction parseDepends(key, parsed) {\r\n    let loader = cc.loader;\r\n    var item = loader.getItem(key);\r\n    if (item) {\r\n        var depends = item.dependKeys;\r\n        if (depends) {\r\n            for (var i = 0; i < depends.length; i++) {\r\n                var depend = depends[i];\r\n                if (!parsed.has(depend)) {\r\n                    parsed.add(depend);\r\n                    parseDepends(depend, parsed);\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction getNodesDepends(nodes) {\r\n    let ret = new Set();\r\n    for (let i = 0; i < nodes.length; i++) {\r\n        visitNode(nodes[i], ret)\r\n    }\r\n    return ret;\r\n}\r\n\r\nfunction visitNode(node, excludeMap) {\r\n    for (let i = 0; i < node._components.length; i++) {\r\n        visitComponent(node._components[i], excludeMap);\r\n    }\r\n    for (let i = 0; i < node._children.length; i++) {\r\n        visitNode(node._children[i], excludeMap);\r\n    }\r\n}\r\n\r\nfunction visitComponent(comp, excludeMap) {\r\n    var props = Object.getOwnPropertyNames(comp);\r\n    for (var i = 0; i < props.length; i++) {\r\n        var value = comp[props[i]];\r\n        if (typeof value === 'object' && value) {\r\n            if (Array.isArray(value)) {\r\n                for (let j = 0; j < value.length; j++) {\r\n                    let val = value[j];\r\n                    if (val instanceof cc.RawAsset) {\r\n                        visitAsset(val, excludeMap);\r\n                    }\r\n                }\r\n            }\r\n            else if (!value.constructor || value.constructor === Object) {\r\n                let keys = Object.getOwnPropertyNames(value);\r\n                for (let j = 0; j < keys.length; j++) {\r\n                    let val = value[keys[j]];\r\n                    if (val instanceof cc.RawAsset) {\r\n                        visitAsset(val, excludeMap);\r\n                    }\r\n                }\r\n            }\r\n            else if (value instanceof cc.RawAsset) {\r\n                visitAsset(value, excludeMap);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction visitAsset(asset, excludeMap) {\r\n    if (!asset._uuid) {\r\n        return;\r\n    }\r\n    let loader = cc.loader;\r\n    var key = loader._getReferenceKey(asset);\r\n    if (!excludeMap.has(key)) {\r\n        excludeMap.add(key);\r\n        parseDepends(key, excludeMap);\r\n    }\r\n}\r\n\r\n\r\nclass CacheInfo {\r\n    refs = new Set();\r\n    uses = new Set();\r\n}\r\n\r\nclass resloader {\r\n\r\n    _resMap = new Map();\r\n    _sceneDepends = null;\r\n    _lastScene = null;\r\n\r\n    constructor() {\r\n        if (!cc.sys.isNative) return;\r\n        let scene = cc.director.getScene();\r\n        if (scene) {\r\n            this._cacheScene(scene);\r\n        }\r\n\r\n        cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH, (scene) => {\r\n            this._cacheScene(scene);\r\n        });\r\n    }\r\n\r\n    // 预加载资源\r\n    loadRes() {\r\n        let resArgs = this._makeLoadResArgs.apply(this, arguments);\r\n\r\n        let finishCallback = (error, resource) => {\r\n            if (!error) {\r\n                console.log(\"打开前：\" + this._resMap.size)\r\n                this._finishItem(resArgs.url, resArgs.type, resArgs.use);\r\n                console.log(\"打开后：\" + this._resMap.size)\r\n            }\r\n            if (resArgs.onCompleted) {\r\n                resArgs.onCompleted(error, resource);\r\n            }\r\n        };\r\n\r\n        // 预判是否资源已加载\r\n        let res = cc.loader.getRes(resArgs.url, resArgs.type);\r\n        if (res) {\r\n            finishCallback(null, res);\r\n        } else {\r\n            let ccloader = cc.loader;\r\n            let uuid = ccloader._getResUuid(resArgs.url, resArgs.type, false);\r\n            if (uuid) {\r\n                cc.loader.loadRes(resArgs.url, resArgs.type, resArgs.onProgess, finishCallback);\r\n            } else {\r\n                cc.loader.load(resArgs.url, resArgs.onProgess, finishCallback);\r\n            }\r\n        }\r\n    }\r\n\r\n    releaseRes() {\r\n\r\n        console.log(\"释放前：\" + this._resMap.size, cc.loader.getResCount());\r\n\r\n        let resArgs = this._makeReleaseResArgs.apply(this, arguments);\r\n        let item = this._getResItem(resArgs.url, resArgs.type);\r\n        if (!item) {\r\n            console.warn(`releaseRes item is null ${resArgs.url} ${resArgs.type}`);\r\n            return;\r\n        }\r\n\r\n        let cacheInfo = this._getCacheInfo(item.id);\r\n        if (resArgs.use) {\r\n            cacheInfo.uses.delete(resArgs.use)\r\n        }\r\n\r\n        if (cacheInfo.uses.size == 0) {\r\n            this._release(item, item.id);\r\n        }\r\n\r\n        console.log(\"释放后：\" + this._resMap.size, cc.loader.getResCount())\r\n    }\r\n\r\n    // 释放一个资源\r\n    _release(item, itemUrl) {\r\n        let cacheInfo = this._getCacheInfo(item.id);\r\n        if (!item || !cacheInfo.refs.has(itemUrl)) {\r\n            return;\r\n        }\r\n\r\n        // 解除自身对自己的引用\r\n        cacheInfo.refs.delete(itemUrl);\r\n        let ccloader = cc.loader;\r\n        if (cacheInfo.uses.size == 0 && cacheInfo.refs.size == 0) {\r\n            if (item.dependKeys && Array.isArray(item.dependKeys)) {\r\n                for (let depKey of item.dependKeys) {\r\n                    let depItem = ccloader._cache[depKey]\r\n                    if (depItem) {\r\n                        this._release(depItem, item.id);\r\n                    }\r\n                }\r\n            }\r\n\r\n            //如果没有uuid,就直接释放url\r\n            if (item.uuid) {\r\n                cc.loader.release(item.uuid);\r\n                console.log(\"resloader release item by uuid :\" + item.id);\r\n            } else {\r\n                cc.loader.release(item.id);\r\n                console.log(\"resloader release item by url:\" + item.id);\r\n            }\r\n            this._resMap.delete(item.id);\r\n        }\r\n    }\r\n\r\n    _getResItem(url, type) {\r\n        let item = cc.loader._cache[url];\r\n        if (!item) {\r\n            let uuid = cc.loader._getResUuid(url, type, false);\r\n            if (uuid) {\r\n                let ref = cc.loader._getReferenceKey(uuid);\r\n                item = cc.loader._cache[ref];\r\n            }\r\n        }\r\n\r\n        return item;\r\n    }\r\n\r\n    _getCacheInfo(key) {\r\n        if (!this._resMap.has(key)) {\r\n            this._resMap.set(key, new CacheInfo());\r\n        }\r\n\r\n        return this._resMap.get(key);\r\n    }\r\n\r\n    _buildDepend(item, refKey) {\r\n        if (item && item.dependKeys && Array.isArray(item.dependKeys)) {\r\n            for (let depKey of item.dependKeys) {\r\n                let cacheInfo = this._getCacheInfo(depKey);\r\n                if (!cacheInfo.refs.has(refKey)) {\r\n                    cacheInfo.refs.add(refKey);\r\n\r\n                    let depItem = cc.loader._cache[depKey];\r\n                    if (depItem) {\r\n                        this._buildDepend(depItem, depItem.id);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    _cacheItem(item, use) {\r\n        if (item && item.id) {\r\n            let cacheInfo = this._getCacheInfo(item.id);\r\n            if (use) {\r\n                cacheInfo.uses.add(use);\r\n            }\r\n\r\n            if (!cacheInfo.refs.has(item.id)) {\r\n                cacheInfo.refs.add(item.id);\r\n                this._buildDepend(item, item.id);\r\n            }\r\n\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    _finishItem(url, assetType, use) {\r\n        let item = this._getResItem(url, assetType);\r\n        if (!this._cacheItem(item, use)) {\r\n            cc.warn(`addDependKey item error! for ${url}`);\r\n        }\r\n    }\r\n\r\n    // 生成加载参数\r\n    _makeLoadResArgs() {\r\n        if (arguments.length < 1) {\r\n            console.error(`_makeLoadResArgs error ${arguments}`);\r\n            return null;\r\n        }\r\n\r\n        if (arguments.length == 1 && (typeof arguments[0] == \"object\")) {\r\n            return arguments[0];\r\n        }\r\n\r\n        let ret = {};\r\n\r\n        if (typeof arguments[0] == \"string\") {\r\n            ret.url = arguments[0];\r\n        } else if (arguments[0] instanceof Array) {\r\n            ret.urls = arguments[0];\r\n        } else {\r\n            console.error(`_makeLoadResArgs error ${arguments}`);\r\n            return null;\r\n        }\r\n\r\n        for (let i = 1; i < arguments.length; ++i) {\r\n            if (i == 1 && isChildClassOf(arguments[i], cc.RawAsset)) {\r\n                // 判断是不是第一个参数type\r\n                ret.type = arguments[i];\r\n            } else if (i == arguments.length - 1 && typeof arguments[i] == \"string\") {\r\n                // 判断是不是最后一个参数use\r\n                ret.use = arguments[i];\r\n            } else if (typeof arguments[i] == \"function\") {\r\n                // 其他情况为函数\r\n                if (arguments.length > i + 1 && typeof arguments[i + 1] == \"function\") {\r\n                    ret.onProgess = arguments[i];\r\n                } else {\r\n                    ret.onCompleted = arguments[i];\r\n                }\r\n            }\r\n        }\r\n        return ret;\r\n    }\r\n\r\n    _releaseSceneDepend() {\r\n        if (this._sceneDepends) {\r\n            let persistDepends = getNodesDepends(this._getPersistNodeList());\r\n            for (let i = 0; i < this._sceneDepends.length; ++i) {\r\n                // 判断是不是已经被场景切换自动释放的资源，是则直接移除缓存Item（失效项）\r\n                let item = this._getResItem(this._sceneDepends[i], undefined);\r\n                if (!item) {\r\n                    this._resMap.delete(this._sceneDepends[i]);\r\n                    console.log(`delete untrack res ${this._sceneDepends[i]}`);\r\n                }\r\n                // 判断是不是持久节点依赖的资源\r\n                else if (!persistDepends.has(this._sceneDepends[i])) {\r\n                    //this.releaseRes(this._sceneDepends[i], this._sceneUseKey);\r\n                }\r\n            }\r\n            this._sceneDepends = null;\r\n        }\r\n    }\r\n\r\n    // 生成释放参数\r\n    _makeReleaseResArgs() {\r\n        if (arguments.length < 1) {\r\n            console.error(`_makeReleaseResArgs error ${arguments}`);\r\n            return null;\r\n        }\r\n        let ret = {};\r\n        if (typeof arguments[0] == \"string\") {\r\n            ret.url = arguments[0];\r\n        } else if (arguments[0] instanceof Array) {\r\n            ret.urls = arguments[0];\r\n        } else {\r\n            console.error(`_makeReleaseResArgs error ${arguments}`);\r\n            return null;\r\n        }\r\n\r\n        for (let i = 1; i < arguments.length; ++i) {\r\n            if (typeof arguments[i] == \"string\") {\r\n                ret.use = arguments[i];\r\n            } else {\r\n                ret.type = arguments[i];\r\n            }\r\n        }\r\n        return ret;\r\n    }\r\n\r\n    _cacheSceneDepend(depends, useKey) {\r\n        for (let i = 0; i < depends.length; ++i) {\r\n            let item = ccloader._cache[depends[i]];\r\n            this._cacheItem(item, useKey);\r\n        }\r\n        return depends;\r\n    }\r\n\r\n    _cacheScene(scene) {\r\n        if (scene.name == this._lastScene) {\r\n            return;\r\n        }\r\n\r\n        let refKey = ccloader._getReferenceKey(scene.uuid);\r\n        let item = ccloader._cache[refKey];\r\n        let newUseKey = scene.uuid;\r\n        let depends = null;\r\n\r\n        if (item) {\r\n            depends = this._cacheSceneDepend(item.dependKeys, newUseKey);\r\n        } else if (scene[\"dependAssets\"]) {\r\n            depends = this._cacheSceneDepend(scene[\"dependAssets\"], newUseKey);\r\n        } else {\r\n            console.error(`cache scene faile ${scene}`);\r\n            return;\r\n        }\r\n\r\n        if (cc.sys.isNative) this._releaseSceneDepend();\r\n        this._lastScene = scene.name;\r\n        this._sceneUseKey = newUseKey;\r\n        this._sceneDepends = depends;\r\n    }\r\n\r\n    _getPersistNodeList() {\r\n        let game = cc.game;\r\n        var persistNodeList = Object.keys(game._persistRootNodes).map(function (x) {\r\n            return game._persistRootNodes[x];\r\n        });\r\n        return persistNodeList;\r\n    }\r\n};\r\n\r\nmodule.exports = function () {\r\n    if (!g_instance) {\r\n        g_instance = new resloader();\r\n    }\r\n    return g_instance;\r\n};"]}