{"version":3,"sources":["assets\\frames\\base\\scene.js"],"names":["Scene","upScene","nowScene","registerEvent","scene","prototype","g_instance","unRegisterEvent","setNextSceneTag","tag","glGame","storage","setItem","scenetag","NEXTSCENETAG","nextSceneTag","getSceneNameByID","ID","sceneDict","getSceneIDByName","gameName","key","enterNextScene","Promise","resolve","reject","cc","director","getScene","name","getItem","PLAZA","nextSceneName","publicPreload","panel","preloadPlazaState","plazaPreload","user","curContinue","changeRollNoticeState","showLoading","notice","exitPlaza","emitter","emit","MESSAGE","UI","HIDE_CLEANUP","preloadplazaPublicMode","then","switchScene","preloadPublicMode","switchGame","gameID","room","reqMyRoomState","customLoadScene","sceneName","onProgress","onComplete","info","_getSceneUuid","self","loader","load","uuid","type","completedCount","totalCount","item","error","asset","errorID","message","PLAZA_LOADING","update_list","sys","isNative","isIos","game","setFrameRate","console","log","loadScene","reqMyInfo","ReqRedDot","audio","initPlazaAodio","systemclass","iphonex","garbageCollect","checkRoomEnter","ROOM_ENTER_SHOW","ROOM_ENTER_HIDE","CHANGE_SCENE_COMPLE","onChangeScene","getUpScene","parseInt","getSceneName","getNowScene","enterNowScene","setTimeout","SCENE","gameNameList","Object","values","nodeEntry","getChildByName","active","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["/**\r\n * 场景管理器\r\n */\r\nlet Scene = function () {\r\n    this.upScene = \"\";\r\n    this.nowScene = \"\";\r\n    this.registerEvent();\r\n},\r\n    scene = Scene.prototype,\r\n    g_instance = null;\r\n\r\nscene.registerEvent = function () {\r\n};\r\nscene.unRegisterEvent = function () {\r\n};\r\nscene.setNextSceneTag = function (tag) {\r\n    glGame.storage.setItem(glGame.scenetag.NEXTSCENETAG, { nextSceneTag: tag });\r\n};\r\nscene.getSceneNameByID = function (ID) {\r\n    return this.sceneDict[ID];\r\n};\r\nscene.getSceneIDByName = function (gameName) {\r\n    for (const key in this.sceneDict) {\r\n        if (this.sceneDict[key] == gameName) {\r\n            return key;\r\n        }\r\n    }\r\n    return null;\r\n};\r\n/**\r\n * 切换到下一个场景\r\n */\r\nscene.enterNextScene = function () {\r\n    return new Promise((resolve, reject) => {\r\n        this.upScene = cc.director.getScene().name;\r\n        let nextSceneTag = glGame.storage.getItem(glGame.scenetag.NEXTSCENETAG) || glGame.scenetag.PLAZA,\r\n            nextSceneName = this.nowScene = glGame.scene.getSceneNameByID(nextSceneTag.nextSceneTag),\r\n            publicPreload = ((nextSceneName !== \"plaza\" && nextSceneName !== \"login\" && !glGame.panel.preloadPlazaState())),\r\n            plazaPreload = (nextSceneName === \"plaza\" && !glGame.panel.preloadPlazaState());\r\n\r\n        if (this.upScene != \"\" && this.upScene != \"login\" && nextSceneName == \"plaza\") glGame.user.curContinue = [];\r\n\r\n        if (nextSceneName === \"plaza\") glGame.panel.changeRollNoticeState(false);\r\n\r\n        if (nextSceneName !== \"plaza\" && (this.upScene == \"plaza\" || this.upScene == \"login\")/*|| plazaPreload*/)\r\n            glGame.panel.showLoading()\r\n\r\n        if (nextSceneName !== \"plaza\" && nextSceneName !== \"login\" && this.upScene === \"plaza\") glGame.notice.exitPlaza();\r\n\r\n        if (this.upScene == \"login\" && nextSceneName == \"plaza\") glGame.emitter.emit(MESSAGE.UI.HIDE_CLEANUP);\r\n\r\n        if (plazaPreload) {\r\n            //预加载大厅资源\r\n            glGame.panel.preloadplazaPublicMode().then(() => {\r\n                this.switchScene(resolve, nextSceneName);\r\n            })\r\n        } else if (publicPreload) {\r\n            glGame.panel.preloadPublicMode().then(() => {\r\n                this.switchScene(resolve, nextSceneName);\r\n            })\r\n        } else {\r\n            this.switchScene(resolve, nextSceneName);\r\n        }\r\n    })\r\n};\r\n\r\n\r\n/**\r\n * 切换游戏\r\n * @param gameID\r\n */\r\nscene.switchGame = function (gameID) {\r\n    glGame.room.reqMyRoomState();\r\n};\r\n\r\nscene.customLoadScene = function(sceneName, onProgress, onComplete) {\r\n    var info = cc.director._getSceneUuid(sceneName);\r\n    var self = this;\r\n    if (info) {\r\n        cc.loader.load({ uuid: info.uuid, type: 'uuid' }, function(completedCount, totalCount, item){\r\n            onProgress(completedCount, totalCount, item)\r\n        }, function(error, asset){\r\n            if (error) {\r\n                cc.errorID(1210, this.sceneName, error.message);\r\n            } else {\r\n                onComplete(error, asset);\r\n　　　　　　　}\r\n         })\r\n     }\r\n}\r\n\r\n\r\nscene.switchScene = function (resolve, nextSceneName) {\r\n    //只在游戏内显示debug\r\n    this.customLoadScene(nextSceneName,(completedCount, totalCount, item)=> {\r\n        glGame.emitter.emit(MESSAGE.UI.PLAZA_LOADING, { completedCount, totalCount });\r\n    },\r\n     () => {\r\n        if (\"plaza\" !== nextSceneName) {\r\n            glGame.update_list = [];\r\n            if (cc.sys.isNative && isIos) cc.game.setFrameRate(30);\r\n        } else {\r\n            if (cc.sys.isNative && isIos) cc.game.setFrameRate(30);\r\n            else if (cc.sys.isNative) cc.game.setFrameRate(30);\r\n        }\r\n        console.log(\"loadScene\", nextSceneName);\r\n        cc.director.loadScene(nextSceneName, () => {\r\n            if (this.upScene != \"login\" && this.upScene != \"plaza\" && nextSceneName == \"plaza\") {\r\n                glGame.user.reqMyInfo();\r\n                glGame.user.ReqRedDot();\r\n                glGame.audio.initPlazaAodio();\r\n            }\r\n            glGame.systemclass.iphonex();\r\n            cc.sys.garbageCollect();\r\n            if (nextSceneName == \"plaza\" && this.upScene != \"login\" && !this.checkRoomEnter()) glGame.emitter.emit(MESSAGE.UI.ROOM_ENTER_SHOW);\r\n            else if (nextSceneName != \"plaza\" && nextSceneName != \"login\") glGame.emitter.emit(MESSAGE.UI.ROOM_ENTER_HIDE);\r\n            resolve()\r\n            console.log(\"loadScene win\", nextSceneName);\r\n            glGame.emitter.emit(MESSAGE.UI.CHANGE_SCENE_COMPLE, nextSceneName);\r\n            glGame.audio.onChangeScene();\r\n        });\r\n    });\r\n}\r\n\r\nscene.getUpScene = function () {\r\n    for (let key in this.sceneDict) {\r\n        if (this.upScene == this.sceneDict[key]) return parseInt(key);\r\n    }\r\n    return 0;\r\n}\r\n\r\nscene.getSceneName = function () {\r\n    return this.nowScene;\r\n}\r\n\r\nscene.getNowScene = function () {\r\n    for (let key in this.sceneDict) {\r\n        if (this.nowScene == this.sceneDict[key]) return parseInt(key);\r\n    }\r\n    return 0;\r\n}\r\n\r\n/**\r\n * 重新加载场景\r\n */\r\nscene.enterNowScene = function () {\r\n    cc.director.loadScene(cc.director.getScene().name, () => { }, () => {\r\n        setTimeout(() => {\r\n            glGame.systemclass.iphonex();\r\n        }, 1000)\r\n        glGame.emitter.emit(MESSAGE.UI.SCENE);\r\n    });\r\n};\r\n\r\n/**\r\n * 校验是否有房间入口界面，且处于开启状态\r\n */\r\nscene.checkRoomEnter = function () {\r\n    let gameNameList = Object.values(this.sceneDict);\r\n    for (let gameName of gameNameList) {\r\n        let nodeEntry = cc.director.getScene().getChildByName(`${gameName}entry`)\r\n        if (nodeEntry && nodeEntry.active) return true;\r\n    }\r\n    return false;\r\n}\r\n\r\nmodule.exports = function () {\r\n    if (!g_instance) {\r\n        g_instance = new Scene();\r\n    }\r\n    return g_instance;\r\n};\r\n"]}