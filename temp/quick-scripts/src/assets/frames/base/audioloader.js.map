{"version":3,"sources":["assets\\frames\\base\\audioloader.js"],"names":["AudioLoader","resetData","audioloader","prototype","g_instance","caches","loadings","progress","callbacks","clearCallback","isLoaded","url","cc","sys","isNative","rootPath","jsb","fileUtils","getWritablePath","filePath","md5","isFileExist","isLoading","getPercent","percent","Math","ceil","loadAudio","callback","audioClip","Promise","resolve","reject","loadNative","loadWeb","self","loader","load","err","basePath","isDirectoryExist","createDirectory","downloader","Downloader","createDownloadFileTask","setOnTaskError","sender","errorCode","errorCodeInternal","errorStr","setOnTaskProgress","bytesReceived","totalBytesReceived","totalBytesExpected","setOnFileTaskSuccess","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["let\r\n    AudioLoader = function () {\r\n        this.resetData();\r\n    },\r\n    audioloader = AudioLoader.prototype,\r\n    g_instance = null;\r\n\r\n/**\r\n * 初始化音量参数\r\n */\r\naudioloader.resetData = function () {\r\n    this.caches = {};\r\n    this.loadings = {};\r\n    this.progress = {};\r\n    this.callbacks = {};\r\n};\r\n\r\naudioloader.clearCallback = function() {\r\n    this.callbacks = {};\r\n}\r\n\r\n// 是否加载完成\r\naudioloader.isLoaded = function(url) {\r\n    if(this.caches[url]) {\r\n        return true;\r\n    }\r\n\r\n    if(cc.sys.isNative) {\r\n        const rootPath = jsb.fileUtils.getWritablePath();\r\n        let filePath = rootPath + \"bgmusic/\" + md5(url) + \".mp3\";\r\n        if(jsb.fileUtils.isFileExist(filePath)) {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n// 是否正在加载\r\naudioloader.isLoading = function(url) {\r\n    return this.loadings[url];\r\n}\r\n\r\n// 获取下载进度\r\naudioloader.getPercent = function(url) {\r\n    let percent = this.progress[url];\r\n    if(percent) {\r\n        return Math.ceil(percent);\r\n    }\r\n\r\n    return 0;\r\n}\r\n\r\n// 加载音频\r\naudioloader.loadAudio = function(url, callback) {\r\n    let audioClip = this.caches[url];\r\n    if(audioClip) {\r\n        return new Promise(function(resolve, reject) {\r\n            resolve(audioClip);\r\n        });\r\n    }\r\n\r\n    if(callback == null) callback = ()=> {};\r\n    this.callbacks[url] = callback;\r\n\r\n    if(this.loadings[url]) {\r\n        return;\r\n    }\r\n\r\n    this.loadings[url] = true;\r\n    this.progress[url] = 0;\r\n    \r\n    if(cc.sys.isNative) {\r\n        return this.loadNative(url);\r\n    } else {\r\n        return this.loadWeb(url);\r\n    }\r\n}\r\n\r\n// web平台加载\r\naudioloader.loadWeb = function(url) {\r\n    let self = this;\r\n    return new Promise(function(resolve, reject) {\r\n        cc.loader.load(url, (err, audioClip)=> {\r\n            if(err) {\r\n                reject(err);\r\n                return;\r\n            }\r\n\r\n            self.caches[url] = audioClip;\r\n            self.loadings[url] = false;\r\n            self.progress[url] = 100;\r\n\r\n            let callback = self.callbacks[url];\r\n            if(callback) {\r\n                callback(url, 100);\r\n            }\r\n\r\n            resolve(audioClip);\r\n        });\r\n    });\r\n}\r\n\r\n// 原生平台加载\r\naudioloader.loadNative = function(url) {\r\n    let self = this;\r\n\r\n    return new Promise(function(resolve, reject) {\r\n        const rootPath = jsb.fileUtils.getWritablePath();\r\n        const basePath = rootPath + \"bgmusic/\";\r\n        if (!jsb.fileUtils.isDirectoryExist(basePath)) {\r\n            jsb.fileUtils.createDirectory(basePath);\r\n        }\r\n\r\n        const filePath = basePath + md5(url) + \".mp3\";\r\n\r\n        if(jsb.fileUtils.isFileExist(filePath)) {\r\n            cc.loader.load(filePath, (err, audioClip)=> {\r\n                self.loadings[url] = false;\r\n                self.progress[url] = 100;\r\n                self.caches[url] = audioClip;\r\n                resolve(audioClip);\r\n            });\r\n\r\n            return;\r\n        }\r\n\r\n        let downloader = new jsb.Downloader();\r\n        downloader.createDownloadFileTask(url, filePath);\r\n        downloader.setOnTaskError((sender, errorCode, errorCodeInternal, errorStr)=> {\r\n\r\n        });\r\n\r\n        downloader.setOnTaskProgress((sender, bytesReceived, totalBytesReceived, totalBytesExpected)=> {\r\n            let percent = Math.ceil(totalBytesReceived / totalBytesExpected * 100);\r\n            self.progress[url] = percent;\r\n            let callback = self.callbacks[url];\r\n            if(callback) {\r\n                callback(url, percent);\r\n            }\r\n        });\r\n\r\n        downloader.setOnFileTaskSuccess((sender)=> {\r\n            cc.loader.load(filePath, (err, audioClip)=> {\r\n                self.caches[url] = audioClip;\r\n                self.loadings[url] = false;\r\n                self.progress[url] = 100;\r\n\r\n                let callback = self.callbacks[url];\r\n                if(callback) {\r\n                    callback(url, 100);\r\n                }\r\n\r\n                resolve(audioClip);\r\n            });\r\n        });\r\n    });\r\n}\r\n\r\nmodule.exports = function () {\r\n    if (!g_instance) {\r\n        g_instance = new AudioLoader();\r\n    }\r\n    return g_instance;\r\n};\r\n"]}