{"version":3,"sources":["assets\\frames\\base\\assets.js"],"names":["AssetsManager","gameName","manifestUrl","processCB","successCB","failCB","resetData","init","assetsManager","prototype","module","exports","base_path","hotUpdateURL","glGame","servercfg","getHotupdateVersionUrl","customManifestStr","JSON","stringify","update_error","fileError","temp_path","jsb","fileUtils","getWritablePath","isDirectoryExist","removeDirectory","_storagePath","console","log","versionCompareHandle","versionA","versionB","_am","setVerifyCallback","path","asset","cc","sys","os","OS_ANDROID","setMaxConcurrentTask","checkUpdate","destroy","setEventCallback","_updating","getState","State","UNINITED","loadLocalManifest","getLocalManifest","isLoaded","manifest","Manifest","checkCb","bind","retry","downloadFailedAssets","panel","showDialog","_canRetry","hotUpdate","updateCb","_failCount","update","event","isUpdate","getEventCode","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","scene","getSceneName","showMsgBox","tips","UPDATE","CHECKFAILED","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","_checkListener","failed","UPDATE_PROGRESSION","getPercentByFile","msg","getMessage","UPDATE_FINISHED","UPDATE_FAILED","ERROR_UPDATING","errorfile","getAssetId","removeFile","ERROR_DECOMPRESS"],"mappings":"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","sourceRoot":"/","sourcesContent":["let AssetsManager = function (gameName, manifestUrl, processCB, successCB, failCB) {\r\n    this.resetData(gameName, manifestUrl, processCB, successCB, failCB);\r\n    this.init(gameName);\r\n},\r\n    assetsManager = AssetsManager.prototype;\r\n\r\nmodule.exports = AssetsManager;\r\nlet base_path = \"master/subpackages/\";//\"master/res/raw-assets/modules/games/\";\r\n/**\r\n * 参数初始化\r\n * @param gameName      游戏code\r\n * @param manifestUrl   本地清单地址\r\n * @param processCB     过程回调\r\n * @param successCB     成功回调\r\n * @param failCB        失败回调\r\n */\r\nassetsManager.resetData = function (gameName, manifestUrl, processCB, successCB, failCB) {\r\n    let hotUpdateURL = glGame.servercfg.getHotupdateVersionUrl();\r\n    this.customManifestStr = JSON.stringify({\r\n        \"packageUrl\": `${hotUpdateURL}${gameName}/`,\r\n        \"remoteManifestUrl\": `${hotUpdateURL}${gameName}/${gameName}project.manifest`,\r\n        \"remoteVersionUrl\": `${hotUpdateURL}${gameName}/${gameName}version.manifest`,\r\n        \"version\": \"0.0.0\",\r\n        \"assets\": {},\r\n        \"searchPaths\": []\r\n    });\r\n    this.manifestUrl = manifestUrl;\r\n    this.processCB = processCB;\r\n    this.successCB = successCB;\r\n    this.failCB = failCB;\r\n    this.update_error = 0;\r\n    this.fileError = false;\r\n    this.gameName = gameName;\r\n};\r\n/**\r\n * 热更下载管理器初始化\r\n * @param gameName\r\n */\r\nassetsManager.init = function (gameName) {\r\n    let temp_path = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + `${base_path + gameName}_temp`);\r\n    if (jsb.fileUtils.isDirectoryExist(temp_path)) {\r\n        jsb.fileUtils.removeDirectory(temp_path);\r\n    }\r\n    this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + `${base_path + gameName}`);\r\n    console.log('本地路径 : ' + this._storagePath);\r\n    this.versionCompareHandle = function (versionA, versionB) {\r\n        console.log(\"JS 自定义版本比较: version A : \" + versionA + ', version B : ' + versionB);\r\n        return versionA === versionB ? 0 : -1;\r\n    };\r\n    this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle);\r\n\r\n    this._am.setVerifyCallback(function (path, asset) {\r\n\r\n        return true;\r\n    });\r\n    if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n        this._am.setMaxConcurrentTask(10);\r\n        console.log(\"Android平台最大并发任务计数限制于2\");\r\n    }\r\n    this.processCB(0);\r\n    // 检测更新\r\n    this.checkUpdate();\r\n};\r\n/**\r\n * 销毁热更下载管理器\r\n */\r\nassetsManager.destroy = function () {\r\n    this._am.setEventCallback(null);\r\n    this._updating = false;\r\n};\r\n\r\n/**\r\n * 检测更新\r\n */\r\nassetsManager.checkUpdate = function () {\r\n    if (this._updating) {\r\n        return console.log(\"正在检查或更新, 请稍等 ...\");\r\n    }\r\n    if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n        console.log(\"正在检查是否需要更新中, 请稍等 ...\");\r\n        this._am.loadLocalManifest(this.manifestUrl);\r\n    }\r\n    if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n        if (this._am.getState() !== jsb.AssetsManager.State.UNINITED) return;\r\n        console.log(\"无法加载本地清单, 使用默认更新清单 ...\");\r\n        let manifest = new jsb.Manifest(this.customManifestStr, this._storagePath);\r\n        this._am.loadLocalManifest(manifest, this._storagePath);\r\n    }\r\n    // this._checkListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\r\n    // cc.eventManager.addListener(this._checkListener, 1);\r\n    this._am.setEventCallback(this.checkCb.bind(this))\r\n    this._am.checkUpdate();\r\n    this._updating = true;\r\n};\r\n/**\r\n * 重试更新\r\n */\r\nassetsManager.retry = function () {\r\n    if (this.update_error <= 2) {\r\n        this.update_error++;\r\n        this._am.downloadFailedAssets();\r\n        this.fileError = false;\r\n    } else {\r\n        glGame.panel.showDialog(\"提示\", \"游戏更新出现小意外，请重新下载\", () => {\r\n            if (!this._updating && this._canRetry) {\r\n                this._am.downloadFailedAssets();\r\n                this._canRetry = false;\r\n                this.fileError = false;\r\n            }\r\n        }, () => {\r\n            this.failCB();\r\n        })\r\n        this._updating = false;\r\n        this._canRetry = true;\r\n    }\r\n};\r\n/**\r\n * 开始更新\r\n */\r\nassetsManager.hotUpdate = function () {\r\n    if (this._am && !this._updating) {\r\n        this._am.setEventCallback(this.updateCb.bind(this))\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            this._am.loadLocalManifest(this.manifestUrl);\r\n        }\r\n        this._failCount = 0;\r\n        this._am.update();\r\n        this._updating = true;\r\n    }\r\n};\r\n/**\r\n * 检测更新事件回掉\r\n */\r\nassetsManager.checkCb = function (event) {\r\n    let isUpdate = false;\r\n    switch (event.getEventCode()) {\r\n        case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n        case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n        case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n            console.log(\"找不到本地清单文件或则无法下载清单文件, 跳过热更新.\");\r\n            if (glGame.scene.getSceneName() != \"plaza\") {\r\n                this.failCB();\r\n            } else {\r\n                glGame.panel.showMsgBox(\"提示\", glGame.tips.UPDATE.CHECKFAILED, () => {\r\n                    // TODO 这里可能要直接退出游戏\r\n                    if (this._am.getState() !== jsb.AssetsManager.State.UNINITED) {\r\n                        this.failCB();\r\n                        return;\r\n                    }\r\n                    let manifest = new jsb.Manifest(this.customManifestStr, this._storagePath);\r\n                    this._am.loadLocalManifest(manifest, this._storagePath);\r\n                    this.checkUpdate();\r\n                });\r\n            }\r\n            break;\r\n        case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n            console.log(\"已经更新了最新的远程版本.\");\r\n            isUpdate = true;\r\n            this.successCB();\r\n            break;\r\n        case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n            console.log(\"'找到新版本, 请尝试更新.\");\r\n            isUpdate = true;\r\n            break;\r\n        default:\r\n            return;\r\n    }\r\n    // cc.eventManager.removeListener(this._checkListener);\r\n    this._am.setEventCallback(null);\r\n    this._checkListener = null;\r\n    this._updating = false;\r\n    if (isUpdate) this.hotUpdate();\r\n};\r\n/**\r\n * 热更新事件回掉\r\n */\r\nassetsManager.updateCb = function (event) {\r\n    // let needRestart = false;\r\n    let failed = false;\r\n    switch (event.getEventCode()) {\r\n        case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n            console.log(\"找不到本地清单文件，跳过热更新.\");\r\n            failed = true;\r\n            break;\r\n        case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n            // this.byteProgress.progress = event.getPercent();\r\n            // this.fileProgress.progress = event.getPercentByFile();\r\n            // this.fileLabel.string = event.getDownloadedFiles() + ' / ' + event.getTotalFiles();\r\n            // this.byteLabel.string = event.getDownloadedBytes() + ' / ' + event.getTotalBytes();\r\n            this.processCB(event.getPercentByFile());\r\n            let msg = event.getMessage();\r\n            if (msg) console.log(\"更新后的文件\", msg);\r\n            break;\r\n        case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n        case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n            console.log(\"无法下载清单文件，跳过热更新.\");\r\n            failed = true;\r\n            break;\r\n        case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n            console.log(\"已经更新了最新的远程版本.\");\r\n            failed = true;\r\n            break;\r\n        case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n            console.log(`更新完成. ${event.getMessage()}`, this.fileError);\r\n            // needRestart = true;\r\n            if (this.fileError) {\r\n                this.retry()\r\n            } else {\r\n                //处理热更缓存记录\r\n                this.successCB();\r\n            }\r\n            break;\r\n        case jsb.EventAssetsManager.UPDATE_FAILED:\r\n            this.retry()\r\n            break;\r\n        case jsb.EventAssetsManager.ERROR_UPDATING:\r\n            let errorfile = (jsb.fileUtils ? jsb.fileUtils.getWritablePath() : \"/\") + this.gameName + \"_temp/\" + event.getAssetId() + \".tmp\";\r\n            jsb.fileUtils.removeFile(errorfile);\r\n            this.fileError = true;\r\n            break;\r\n        case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n            console.log(`jsb.EventAssetsManager.ERROR_DECOMPRESS ${event.getMessage()}`);\r\n            break;\r\n        default:\r\n            break;\r\n    }\r\n\r\n    if (failed) {\r\n        this._am.setEventCallback(null);\r\n        this._updating = false;\r\n    }\r\n};\r\n\r\n"]}