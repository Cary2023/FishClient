{"version":3,"sources":["assets\\frames\\base\\fileutil.js"],"names":["FileUtil","fileUtil","prototype","g_instance","readManifest","path","Promise","resolve","reject","cc","loader","load","err","data","console","error","log","readJSON","fetchJSON","loadRes","readPrefab","scene","director","getScene","showMask","visibleSize","view","getVisibleSize","node","Node","name","setContentSize","setPosition","Vec2","width","height","addComponent","Button","addChild","getChildByName","obj","getRes","destroy","call","scene_call","isEnableHotUpdate","glGame","resloader","Prefab","readAnimation","AnimationClip","readAudio","AudioClip","releasePrefab","gctimeout","clearTimeout","releaseRes","setTimeout","sys","garbageCollect","clearGCTimeOut","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["let\r\n    FileUtil = function () { },\r\n    fileUtil = FileUtil.prototype,\r\n    g_instance = null;\r\n\r\n/**\r\n * manifest 文件读取\r\n * @param {String} path: gamesSearchPath--glGame.gamelistcfg.getGameSearchPaths(this.gameID)\r\n * @returns {Promise}\r\n */\r\nfileUtil.readManifest = function (path) {\r\n    return new Promise(function (resolve, reject) {\r\n        cc.loader.load(`res/raw-assets/${path}.manifest`, function (err, data) {\r\n            if (err) {\r\n                console.error(`${path}.manifest 文件读取失败`);\r\n                return reject(err);\r\n            }\r\n            console.log(`读取manifest文件 ${path}.manifest`);\r\n            resolve(data);\r\n        })\r\n    })\r\n};\r\n\r\n/**\r\n * JSON 文件读取\r\n * @param {String} path: config/serverCfg\r\n * @returns {Promise}\r\n */\r\nfileUtil.readJSON = function (path) {\r\n    return new Promise(function (resolve, reject) {\r\n        cc.loader.load(`res/raw-assets/${path}.json`, function (err, data) {\r\n            if (err) {\r\n                console.error(`${path}.json 文件读取失败`);\r\n                return reject(err);\r\n            }\r\n            console.log(`读取json文件 ${path}.json: `, data);\r\n            resolve(data);\r\n        })\r\n    })\r\n};\r\nfileUtil.fetchJSON = function (path) {\r\n    return new Promise(function (resolve, reject) {\r\n        cc.loader.loadRes(`text/${path}.json`, function (err, data) {\r\n            if (err) {\r\n                console.error(`${path}.json 文件读取失败`);\r\n                return reject(err);\r\n            }\r\n            console.log(`读取json文件 ${path}.json: `, data);\r\n            resolve(data);\r\n        })\r\n    })\r\n};\r\n/**\r\n * 预制资源文件读取\r\n * @param {String} path\r\n * @returns {Promise}\r\n */\r\nfileUtil.readPrefab = function (path) {\r\n    // 加载单个资源的时候暂时屏蔽掉界面上所有操作\r\n    let scene = cc.director.getScene();\r\n    let showMask = () => {\r\n        let visibleSize = cc.view.getVisibleSize();\r\n        let node = new cc.Node();\r\n        node.name = \"loadmask\";\r\n        node.setContentSize(visibleSize);\r\n        node.setPosition(new cc.Vec2(visibleSize.width / 2, visibleSize.height / 2));\r\n        node.addComponent(cc.Button);\r\n        scene.addChild(node, 1000);\r\n    };\r\n    if (!scene.getChildByName(\"loadmask\")) showMask();\r\n\r\n    return new Promise(function (resolve, reject) {\r\n        // 已加载的预支不在做动态加载，直接又相关接口获取\r\n        let obj = cc.loader.getRes(path);\r\n        if (obj != null) {\r\n            if (scene && scene.getChildByName(\"loadmask\")) scene.getChildByName(\"loadmask\").destroy();\r\n            resolve(obj);\r\n            return;\r\n        }\r\n        console.log(\"loadRes getRes == :\", obj, path);\r\n        let call = function (err, data) {\r\n            let scene_call = cc.director.getScene();\r\n            if (scene_call && scene_call.getChildByName(\"loadmask\")) scene_call.getChildByName(\"loadmask\").destroy();\r\n            if (err) {\r\n                console.error(`${path}.prefab 文件读取失败`);\r\n                return reject(err);\r\n            }\r\n            resolve(data);\r\n        }\r\n        if (isEnableHotUpdate) glGame.resloader.loadRes(path, cc.Prefab, call);\r\n        else cc.loader.loadRes(path, cc.Prefab, call)\r\n    })\r\n};\r\n/**\r\n * 动画资源文件读取\r\n * @param path\r\n * @returns {Promise}\r\n */\r\nfileUtil.readAnimation = function (path) {\r\n    return new Promise((resolve, reject) => {\r\n        cc.loader.loadRes(path, cc.AnimationClip, (err, data) => {\r\n            if (err) {\r\n                console.error(`${path}.anim 文件读取失败`);\r\n                return reject(data);\r\n            }\r\n            resolve(data);\r\n        })\r\n    })\r\n};\r\n\r\n\r\n/**\r\n * 动画资源文件读取\r\n * @param path\r\n * @returns {Promise}\r\n */\r\nfileUtil.readAudio = function (path) {\r\n    return new Promise((resolve, reject) => {\r\n        cc.loader.loadRes(path, cc.AudioClip, (err, data) => {\r\n            if (err) {\r\n                console.error(`${path}.mp3 文件读取失败`);\r\n                return reject(data);\r\n            }\r\n            resolve(data);\r\n        })\r\n    })\r\n};\r\n\r\n/**\r\n * 动画资源文件读取\r\n * @param path\r\n * @returns {Promise}\r\n */\r\nfileUtil.releasePrefab = function (path) {\r\n\r\n    if (isEnableHotUpdate) {\r\n        if (this.gctimeout) clearTimeout(this.gctimeout);\r\n        glGame.resloader.releaseRes(path);\r\n        this.gctimeout = setTimeout(() => {\r\n            cc.sys.garbageCollect();\r\n            this.gctimeout = null;\r\n        }, 1000);\r\n    }\r\n\r\n    // let data = cc.loader.getRes(path);\r\n    // if (data == null) return;\r\n    // cc.loader.setAutoReleaseRecursively(data, true);\r\n    // var deps = cc.loader.getDependsRecursively(data);\r\n    // cc.loader.release(deps);\r\n    // cc.sys.garbageCollect();\r\n    // cc.loader.releaseRes(path, cc.Prefab);\r\n    // console.log(\"releasePrefab\", path);\r\n};\r\n\r\n/**\r\n * 关闭延迟GC\r\n */\r\nfileUtil.clearGCTimeOut = function(){\r\n    if (this.gctimeout) {\r\n        clearTimeout(this.gctimeout);\r\n        this.gctimeout = null;\r\n    }\r\n}\r\n\r\nmodule.exports = function () {\r\n    if (!g_instance) {\r\n        g_instance = new FileUtil();\r\n        g_instance.gctimeout = null;\r\n    }\r\n    return g_instance;\r\n};"]}