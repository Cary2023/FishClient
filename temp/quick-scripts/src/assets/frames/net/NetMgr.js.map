{"version":3,"sources":["assets\\frames\\net\\NetMgr.js"],"names":["G_NETTYPE","httpPost","httpGet","pomelo","netdef_reqmaxtime","netdef_reqPhoneCodeTime","NetMgr","resetNetMgrData","netMgr","prototype","g_instance","window","msgindex","msgrecords","_uid","_token","timer_req","pomelo_plat","setInterval","checkReq","bind","setLoginInfo","uid","setLoginToken","token","getLoginToken","pomeloDisconnected","pomeloConnecting","pomeloConnected","clearPomeloReqs","resendPomeloReqs","getConnectionStatus","platSucceed","platDisconnect","glGame","emitter","emit","httpReSendMsgs","route","record","date","Date","time","parse","http_push","serverType","push","length","gameNet","reSendMsgs","clearTimer","clearTimeout","destroy","convertMsg","msg","next","version","words","split","wordslen","ret","newmsg","server","head","body","NETWORK","POMELO","ENTER_PLAT","newRecord","serverTimeout","doneWithRoute","code","Object","keys","panel","closeJuHua","closeRoomJuHua","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["﻿let\r\n\tG_NETTYPE = {\r\n\t\thttpPost: 1,\r\n\t\thttpGet: 3,\r\n\t\tpomelo: 4\r\n\t},\r\n\tnetdef_reqmaxtime = 5000,\r\n\tnetdef_reqPhoneCodeTime = 30000,\r\n\tNetMgr = function () {\r\n\t\tthis.resetNetMgrData();\r\n\t},\r\n\tnetMgr = NetMgr.prototype,\r\n\tg_instance = null;\r\nwindow['G_NETTYPE'] = G_NETTYPE;\r\nnetMgr.resetNetMgrData = function () {\r\n\tthis.msgindex = 0;//消息索引\r\n\tthis.msgrecords = {};\r\n\tthis._uid = null;\r\n\tthis._token = null;\r\n\tthis.timer_req = null;//请求的事件检测定时器\r\n\tthis.pomelo_plat = false;\r\n\tthis.timer_req = setInterval(this.checkReq.bind(this), 1)\r\n}\r\n//设置登录信息\r\nnetMgr.setLoginInfo = function (uid) {\r\n\tthis._uid = uid;\r\n}\r\n\r\n//设置Token数据\r\nnetMgr.setLoginToken = function (token) {\r\n\tif (token) this._token = token;\r\n}\r\n\r\n//设置Token数据\r\nnetMgr.getLoginToken = function (token) {\r\n\treturn this._token;\r\n}\r\n\r\n//高数网络管理pomelo断开了\r\nnetMgr.pomeloDisconnected = function () {\r\n\r\n}\r\n//告诉网络管理pomelo正在连接中\r\nnetMgr.pomeloConnecting = function () {\r\n\r\n}\r\nnetMgr.pomeloConnected = function () {\r\n\r\n}\r\n//在LoginMgr重连后清空pomelo的请求\r\nnetMgr.clearPomeloReqs = function () {\r\n\r\n}\r\n//重发pomelo的消息\r\nnetMgr.resendPomeloReqs = function () {\r\n\r\n}\r\n\r\n//当前连接状态\r\nnetMgr.getConnectionStatus = function () {\r\n\treturn this.pomelo_plat;\r\n}\r\n\r\n//成功连接平台服\r\nnetMgr.platSucceed = function () {\r\n\tthis.pomelo_plat = true;\r\n}\r\n\r\n//无连接平台服\r\nnetMgr.platDisconnect = function () {\r\n\tglGame.emitter.emit(\"net.disconnect\");\r\n\tthis.pomelo_plat = false;\r\n}\r\n\r\n//检测发送队列\r\nnetMgr.checkReq = function () {\r\n\t//超时的服务器类型\r\n\t//记录需要重新投递的http消息队列\r\n\tlet httpReSendMsgs = [];\r\n\t//记录需要重连的网络\r\n\t//let webNeedReconnect = {};\r\n\tfor (let route in this.msgrecords) {\r\n\t\tlet record = this.msgrecords[route];\r\n\t\tlet date = new Date()\r\n\t\tlet time = Date.parse(date);\r\n\t\tlet http_push = function () {\r\n\t\t\t//如果是当前类型服务器已经停止了则直接不考虑其超时问题,直接加入到重连成功后的重发队列并移除\r\n\t\t\t//在重连前都要记录重发时间\r\n\t\t\tlet date = new Date()\r\n\t\t\tlet time = Date.parse(date);\r\n\t\t\trecord.time = time;//重置发送时间\r\n\t\t\tswitch (record.serverType) {\r\n\t\t\t\tcase G_NETTYPE.pomelo: //表示长连接的服务器\r\n\t\t\t\t\t//说明需要重新连接\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase G_NETTYPE.httpPost:\r\n\t\t\t\tcase G_NETTYPE.httpGet:\r\n\t\t\t\t\t//短连接部分直接插入重新投递\r\n\t\t\t\t\thttpReSendMsgs.push(record);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t//绑定手机重连时间与其他协议时间不同\r\n\t\tif (record.route == \"http.ReqPostPhoneCode\") {\r\n\t\t\tif (time - record.time > netdef_reqPhoneCodeTime) http_push();\r\n\t\t} else {\r\n\t\t\tif (time - record.time > netdef_reqmaxtime) http_push();\r\n\t\t}\r\n\t\t//console.log(\"需要显示菊花route=\",route)\r\n\r\n\t}\r\n\t//重发http的消息\r\n\tif (httpReSendMsgs.length > 0) {\r\n\t\tglGame.gameNet.reSendMsgs(httpReSendMsgs);\r\n\t}\r\n}\r\n//清除定时器\r\nnetMgr.clearTimer = function () {\r\n\tif (this.timer_req != null) {\r\n\t\tclearTimeout(this.timer_req);\r\n\t\tthis.timer_req = null;\r\n\t}\r\n}\r\nnetMgr.destroy = function () {\r\n\tthis.clearTimer();\r\n\tthis.resetNetMgrData();\r\n}\r\n//转换消息成带msgindex的格式\r\nnetMgr.convertMsg = function (route, msg, next, version = \"v1\") {\r\n\tlet words = route.split('.');\r\n\tlet wordslen = words.length\r\n\tlet serverType = -1;\r\n\tlet ret = {};\r\n\tlet newmsg = null;\r\n\tif (wordslen <= 0) {\r\n\t\treturn null;\r\n\t}\r\n\tlet server = words[0];\r\n\tswitch (route) {\r\n\t\tcase 'http.reqLogin':\r\n\t\tcase 'http.reqRegister':\r\n\t\tcase 'http.reqGameSwitch':\r\n\t\tcase 'http.reqPoint':\r\n\t\tcase 'http.reqPostPhoneCode':\r\n\t\tcase 'http.reqResetPwd':\r\n\t\tcase 'http.reqGameList':\r\n\t\tcase 'http.ReqRegisterConfig':\r\n\t\tcase 'http.reqUrl':\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tif (this._uid == null || this._token == null) {\r\n\t\t\t\treturn -1;\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t}\r\n\tswitch (server) {\r\n\t\tcase 'http':\r\n\t\t\tserverType = G_NETTYPE.httpPost;\r\n\t\t\t//判断http投递情况\r\n\t\t\tnewmsg = {\r\n\t\t\t\thead: {\r\n\t\t\t\t\tmsgindex: this.msgindex,\r\n\t\t\t\t\ttoken: this._token,\r\n\t\t\t\t\troute: route,\r\n\t\t\t\t\tversion: version,\r\n\t\t\t\t},\r\n\t\t\t\tbody: msg\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\t\tcase 'hget':\r\n\t\t\tserverType = G_NETTYPE.httpGet;\r\n\t\t\t//判断hget投递情况\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tserverType = G_NETTYPE.pomelo;\r\n\t\t\tmsg.msgindex = this.msgindex;\r\n\t\t\t//判断pomelo投递情况\r\n\t\t\tbreak;\r\n\t}\r\n\tif (serverType == G_NETTYPE.pomelo && !this.pomelo_plat && route !== NETWORK.POMELO.ENTER_PLAT) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\t//将消息保存下来\r\n\tlet date = new Date()\r\n\tlet time = Date.parse(date);\r\n\tlet newRecord = {};\r\n\tnewRecord['time'] = time;\r\n\tnewRecord['serverType'] = serverType;\r\n\tnewRecord['route'] = route;\r\n\tnewRecord['next'] = next;\r\n\tnewRecord['sendNum'] = 0;\r\n\tif (newmsg) {\r\n\t\tnewRecord['msg'] = newmsg;\r\n\t}\r\n\telse {\r\n\t\tnewRecord['msg'] = msg;\r\n\t}\r\n\r\n\tif (serverType != G_NETTYPE.pomelo) {\r\n\t\t//已在重发列表中，需要禁止重复发包的几个协议\r\n\t\tif (this.msgrecords[route]) {\r\n\t\t\tswitch (route) {\r\n\t\t\t\tcase 'http.reqLogin':\r\n\t\t\t\t\treturn null;\r\n\t\t\t\tdefault: break;\r\n\t\t\t}\r\n\t\t}\r\n\t\t//校验是否添加入重发列表中\r\n\t\tswitch (route) {\r\n\t\t\t//指定发包协议，不加入重复发包且发包延迟改为15000毫秒（15秒）\r\n\t\t\tcase 'http.reqBack': ret.serverTimeout = 15000 ;break;\r\n\t\t\tdefault:\r\n\t\t\t\tthis.msgrecords[route] = newRecord;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tret.serverType = serverType;\r\n\tret.msg = newRecord['msg'];\r\n\r\n\tthis.msgindex++;\r\n\r\n\treturn ret;\r\n}\r\n//消息回复后的处理\r\nnetMgr.doneWithRoute = function (route, code) {\r\n\tif (this.msgrecords[route]) {\r\n\t\tdelete this.msgrecords[route];\r\n\t}\r\n\t// console.log(\"当前消息队列的消息 this.msgrecords:\", Object.keys(this.msgrecords));\r\n\tif (Object.keys(this.msgrecords).length == 0) {\r\n\t\tglGame.panel.closeJuHua();\r\n\t}\r\n\tglGame.panel.closeRoomJuHua();\r\n}\r\n\r\nmodule.exports = function () {\r\n\tif (!g_instance) {\r\n\t\tg_instance = new NetMgr();\r\n\t}\r\n\treturn g_instance;\r\n}();"]}