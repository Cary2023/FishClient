{"version":3,"sources":["assets\\frames\\net\\GameNet.js"],"names":["http","require","NetMgr","errCheck","GameNet","webhost","timeout","gameNet","prototype","g_instance","getNetMgr","setWebHost","getWebHost","send_msg","route","msg","next","version","glGame","panel","showJuHua","info","convertMsg","serverType","serverTimeout","newmsg","G_NETTYPE","httpPost","POST","httpGet","GET","pomelo","pomeloReq","console","error","reSendMsgs","records","i","length","record","sendNum","log","checkSendLimit","request","connect","host","port","connectcb","cfg","debug","msgcb","code","data","CheckError","emitter","emit","JSON","stringify","init","pomeloConnecting","disconnect","getState","destroy","clearListener","module","exports"],"mappings":"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","sourceRoot":"/","sourcesContent":["﻿let\r\n\thttp = require(\"http\"),\r\n\tNetMgr = require(\"NetMgr\"),\r\n\terrCheck = require(\"errckect\"),\r\n\tGameNet = function () {\r\n\t\tthis.webhost = null;\r\n\t\tthis.timeout = 5000;\t//正常发包延迟5000毫秒\r\n\t},\r\n\tgameNet = GameNet.prototype,\r\n\tg_instance = null;\r\n\r\n\r\n\r\ngameNet.getNetMgr = function () {\r\n\treturn NetMgr;\r\n}\r\ngameNet.setWebHost = function (webhost) {\r\n\tthis.webhost = webhost\r\n}\r\ngameNet.getWebHost = function () {\r\n\treturn this.webhost;\r\n}\r\n//拼装数据\r\ngameNet.send_msg = function (route, msg, next, version) {\r\n\tglGame.panel.showJuHua();\r\n\t//如果没有消息就构造一个\r\n\tif (msg == null || msg == 'undefined') msg = {};\r\n\t//绑定一个消息id\r\n\tlet info = NetMgr.convertMsg(route, msg, next, version);\r\n\tif (!info) return 0;\r\n\tlet serverType = info.serverType;\r\n\tlet serverTimeout = info.serverTimeout || this.timeout;\r\n\tlet newmsg = info.msg;\r\n\tswitch (serverType) {\r\n\t\tcase G_NETTYPE.httpPost://http post\r\n\t\t\thttp.POST(route, newmsg, next, false, serverTimeout);\r\n\t\t\tbreak;\r\n\t\tcase G_NETTYPE.httpGet://http get\r\n\t\t\thttp.GET(route, newmsg, next);\r\n\t\t\tbreak;\r\n\t\tcase G_NETTYPE.pomelo://pomelo\r\n\t\t\tthis.pomeloReq(route, newmsg);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\treturn console.error(\"gameNet.send_msg: no find serverType ->\", serverType)\r\n\t}\r\n\treturn serverType;\r\n}\r\n\r\n//重发消息\r\ngameNet.reSendMsgs = function (records) {\r\n\tfor (let i = 0; i < records.length; ++i) {\r\n\t\tlet record = records[i];\r\n\t\tlet serverType = record.serverType;\r\n\t\tlet route = record.route;\r\n\t\tlet msg = record.msg;\r\n\t\tlet next = record.next;\r\n\r\n\t\trecord.sendNum += 1;\r\n\t\tconsole.log(\"[reSendMsgs] route:\", route, \"sendNum:\", record.sendNum);\r\n\t\tif (errCheck.checkSendLimit(record.sendNum)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tswitch (serverType) {\r\n\t\t\tcase G_NETTYPE.httpPost://http post\r\n\t\t\t\thttp.POST(route, msg, next, true);\r\n\t\t\t\tbreak;\r\n\t\t\tcase G_NETTYPE.httpGet://http get\r\n\t\t\t\thttp.GET(route, msg, next);\r\n\t\t\t\tbreak;\r\n\t\t\tcase G_NETTYPE.pomelo://pomelo\r\n\t\t\t\tthis.pomeloReq(route, msg);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tconsole.error(\"gameNet.reSendMsgs: no find serverType ->\", serverType)\r\n\t\t}\r\n\t}\r\n}\r\n\r\n//tcp请求\r\ngameNet.pomeloReq = function (route, msg) {\r\n\tpomelo.request(route, msg)\r\n}\r\n\r\ngameNet.connect = function (host, port, connectcb) {\r\n\t//广播连接事件\r\n\tlet cfg = {\r\n\t\thost: host,\r\n\t\tport: port,\r\n\t\tdebug: true,\r\n\t\tmsgcb: function (route, code, data) {\r\n\t\t\tconsole.log(route);\r\n\t\t\tif (errCheck.CheckError(route, code, data)) {\r\n\t\t\t\t// console.log(\"非错误消息,准备广播\", route);\r\n\t\t\t\tglGame.emitter.emit(route, data);\r\n\t\t\t}\r\n\t\t},\r\n\t\tconnectcb: connectcb,\r\n\t};\r\n\tconsole.log(\"连接配置=\", JSON.stringify(cfg));\r\n\tpomelo.init(cfg)\r\n\t//告诉网络管理pomelo开始连接\r\n\tNetMgr.pomeloConnecting();\r\n}\r\ngameNet.disconnect = function () {\r\n\tpomelo.disconnect()\r\n}\r\ngameNet.getState = function () {\r\n\treturn pomelo.getState();\r\n}\r\ngameNet.destroy = function () {\r\n\tNetMgr.destroy();\r\n\tpomelo.clearListener();\r\n}\r\n\r\nmodule.exports = function () {\r\n\tif (!g_instance) {\r\n\t\tg_instance = new GameNet();\r\n\t}\r\n\treturn g_instance;\r\n};"]}