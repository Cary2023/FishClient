
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/modules/plaza/script/prefab/setting/settingSelectMusic.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '558255nwSFBHI6IkYr1+faP', 'settingSelectMusic');
// modules/plaza/script/prefab/setting/settingSelectMusic.js

"use strict";

/**
 * 设置
 */
glGame.baseclass.extend({
  properties: {
    content: cc.Node,
    item: cc.Node
  },
  onLoad: function onLoad() {
    this.netMusic = null; // 网络音乐列表

    this.localMusic = []; // 本地音乐列表

    var localCount = glGame.audio.musicList.length;

    for (var i = 0; i < localCount; i++) {
      this.localMusic[i] = {
        name: glGame.audio.musicList[i]
      };
    }

    this.audioMap = {};
    this.bgName = glGame.storage.getItem("bgName") || {
      audio: this.localMusic[0].name
    };
    this.index = 0;
    this.bInit = false;
    this.reqBackgroundMusic();
  },
  OnClickToggle: function OnClickToggle(event) {
    if (!this.bInit) return;
    var buttonName = event.node.name;
    var buttonNode = event.node;
    glGame.audio.playLoadSoundEffectByPath("select");
    this.onClick(buttonName, buttonNode);
  },
  onClick: function onClick(name, node) {
    switch (name) {
      case "toggle":
        this.click_itemAudio(node);
        break;

      case "download":
        this.click_download(node);
        break;
    }
  },
  // 初始化本地音乐列表
  initLocalMusic: function initLocalMusic() {
    var localMusic = this.localMusic;
    var count = localMusic.length;

    for (var i = 0; i < count; i++) {
      var item = cc.instantiate(this.item);
      item.active = true;
      item.index = i;
      item.parent = this.content;
      item.getChildByName("title").getComponent(cc.Label).string = localMusic[i].name;
      item.getChildByName("download").active = false;
      item.getChildByName("download").index = i;

      if (this.bgName.audio == localMusic[i].name) {
        this.setToggle(item);
        this.index = i;
      }

      this.audioMap[localMusic[i].name] = {
        name: localMusic[i],
        node: item
      };
    }
  },
  // 初始化网络音乐列表
  initNetMusic: function initNetMusic() {
    var netMusic = this.netMusic.data;
    var localCount = this.localMusic.length;
    var count = netMusic.length;

    for (var i = 0; i < count; i++) {
      var item = cc.instantiate(this.item);
      item.active = true;
      item.index = localCount + i;
      item.parent = this.content;
      item.getChildByName("title").getComponent(cc.Label).string = netMusic[i].name;
      item.getChildByName("download").index = localCount + i;
      var url = netMusic[i].url;

      if (this.bgName.audio == url) {
        this.setToggle(item);
        this.index = localCount + i;
      }

      if (cc.sys.isNative) {
        if (!glGame.audioloader.isLoaded(url)) {
          if (glGame.audioloader.isLoading(url)) {
            this.setPercent(url, glGame.audioloader.getPercent(url));
            glGame.audioloader.loadAudio(url, this.onLoadProgress.bind(this));
          } else {
            item.getChildByName("download").active = true;
          }
        }
      }

      this.audioMap[netMusic[i].url] = {
        data: netMusic[i],
        node: item
      };
    }

    var allLength = localCount + count;
    var height = Math.ceil(allLength / 2) * 128;
    this.content.height = height;
    var scorllview = this.node.getChildByName("scrollview").getComponent(cc.ScrollView);
    scorllview.scrollToTop();
  },
  click_itemAudio: function click_itemAudio(node) {
    var _this = this;

    if (!this.bInit) {
      return false;
    }

    var localCount = this.localMusic.length;
    var musicList = this.netMusic.data;
    var index = node.index;
    this.index = index;
    this.hideAllSpine();
    node.getChildByName("sp_play").active = true;

    if (index < localCount) {
      glGame.storage.setItem("bgName", {
        audio: this.localMusic[index].name
      });
      glGame.audio.playPathBGM();
    } else {
      var url = musicList[node.index - localCount].url;
      glGame.audioloader.loadAudio(url, this.onLoadProgress.bind(this)).then(function (audioClip) {
        if (_this.index != index) return;
        glGame.storage.setItem("bgName", {
          audio: url,
          netMusic: true
        });
        glGame.audio.playBGM(audioClip);
      });

      if (cc.sys.isNative) {
        if (!glGame.audioloader.isLoaded(url)) {
          node.getChildByName("process").active = true;
        }

        node.getChildByName("download").active = false;
      }
    }
  },
  click_download: function click_download(node) {
    var localCount = this.localMusic.length;
    var musicList = this.netMusic.data;
    var index = node.index - localCount;
    var url = musicList[index].url;

    if (glGame.audioloader.isLoaded(url)) {
      return;
    }

    if (glGame.audioloader.isLoading(url)) {
      return;
    }

    node.getChildByName("Background").active = false;
    glGame.audioloader.loadAudio(url, this.onLoadProgress.bind(this));
    this.reqBackgroundMusicDownloadsInc(musicList[index].id);
  },
  hideAllSpine: function hideAllSpine() {
    for (var k in this.audioMap) {
      var item = this.audioMap[k];
      item.node.getChildByName("sp_play").active = false;
    }
  },
  // 音乐下载进度
  onLoadProgress: function onLoadProgress(url, percent) {
    this.setPercent(url, percent);
  },
  // 设置百分比
  setPercent: function setPercent(url, percent) {
    var info = this.audioMap[url];
    if (!info) return;
    var node = info.node;
    var progress = node.getChildByName("process");
    var download = node.getChildByName("download");

    if (percent == 100) {
      progress.active = false;
      download.active = false;
      return;
    }

    progress.active = true;
    progress.getChildByName("pro").getComponent(cc.ProgressBar).progress = percent / 100;
    progress.getChildByName("label").getComponent(cc.Label).string = "".concat(percent, "%");
  },
  setToggle: function setToggle(node) {
    node.getComponent(cc.Toggle).isChecked = true;
    node.getChildByName("sp_play").active = true;
  },
  reqBackgroundMusic: function reqBackgroundMusic() {
    var _this2 = this;

    glGame.gameNet.send_msg('http.ReqBackgroundMusic', {
      page: 1,
      pageSize: 100
    }, function (route, msg) {
      _this2.netMusic = msg;
      var data = _this2.netMusic.data;

      _this2.initLocalMusic();

      _this2.initNetMusic();

      _this2.bInit = true;
    });
  },
  reqBackgroundMusicDownloadsInc: function reqBackgroundMusicDownloadsInc(id) {
    glGame.gameNet.send_msg('http.ReqBackgroundMusicDownloadsInc', {
      id: id
    }, function (route, msg) {});
  },
  OnDestroy: function OnDestroy() {
    glGame.audioloader.clearCallback();
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcbW9kdWxlc1xccGxhemFcXHNjcmlwdFxccHJlZmFiXFxzZXR0aW5nXFxzZXR0aW5nU2VsZWN0TXVzaWMuanMiXSwibmFtZXMiOlsiZ2xHYW1lIiwiYmFzZWNsYXNzIiwiZXh0ZW5kIiwicHJvcGVydGllcyIsImNvbnRlbnQiLCJjYyIsIk5vZGUiLCJpdGVtIiwib25Mb2FkIiwibmV0TXVzaWMiLCJsb2NhbE11c2ljIiwibG9jYWxDb3VudCIsImF1ZGlvIiwibXVzaWNMaXN0IiwibGVuZ3RoIiwiaSIsIm5hbWUiLCJhdWRpb01hcCIsImJnTmFtZSIsInN0b3JhZ2UiLCJnZXRJdGVtIiwiaW5kZXgiLCJiSW5pdCIsInJlcUJhY2tncm91bmRNdXNpYyIsIk9uQ2xpY2tUb2dnbGUiLCJldmVudCIsImJ1dHRvbk5hbWUiLCJub2RlIiwiYnV0dG9uTm9kZSIsInBsYXlMb2FkU291bmRFZmZlY3RCeVBhdGgiLCJvbkNsaWNrIiwiY2xpY2tfaXRlbUF1ZGlvIiwiY2xpY2tfZG93bmxvYWQiLCJpbml0TG9jYWxNdXNpYyIsImNvdW50IiwiaW5zdGFudGlhdGUiLCJhY3RpdmUiLCJwYXJlbnQiLCJnZXRDaGlsZEJ5TmFtZSIsImdldENvbXBvbmVudCIsIkxhYmVsIiwic3RyaW5nIiwic2V0VG9nZ2xlIiwiaW5pdE5ldE11c2ljIiwiZGF0YSIsInVybCIsInN5cyIsImlzTmF0aXZlIiwiYXVkaW9sb2FkZXIiLCJpc0xvYWRlZCIsImlzTG9hZGluZyIsInNldFBlcmNlbnQiLCJnZXRQZXJjZW50IiwibG9hZEF1ZGlvIiwib25Mb2FkUHJvZ3Jlc3MiLCJiaW5kIiwiYWxsTGVuZ3RoIiwiaGVpZ2h0IiwiTWF0aCIsImNlaWwiLCJzY29ybGx2aWV3IiwiU2Nyb2xsVmlldyIsInNjcm9sbFRvVG9wIiwiaGlkZUFsbFNwaW5lIiwic2V0SXRlbSIsInBsYXlQYXRoQkdNIiwidGhlbiIsImF1ZGlvQ2xpcCIsInBsYXlCR00iLCJyZXFCYWNrZ3JvdW5kTXVzaWNEb3dubG9hZHNJbmMiLCJpZCIsImsiLCJwZXJjZW50IiwiaW5mbyIsInByb2dyZXNzIiwiZG93bmxvYWQiLCJQcm9ncmVzc0JhciIsIlRvZ2dsZSIsImlzQ2hlY2tlZCIsImdhbWVOZXQiLCJzZW5kX21zZyIsInBhZ2UiLCJwYWdlU2l6ZSIsInJvdXRlIiwibXNnIiwiT25EZXN0cm95IiwiY2xlYXJDYWxsYmFjayJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7O0FBSUFBLE1BQU0sQ0FBQ0MsU0FBUCxDQUFpQkMsTUFBakIsQ0FBd0I7QUFDcEJDLEVBQUFBLFVBQVUsRUFBRTtBQUNSQyxJQUFBQSxPQUFPLEVBQUVDLEVBQUUsQ0FBQ0MsSUFESjtBQUVSQyxJQUFBQSxJQUFJLEVBQUVGLEVBQUUsQ0FBQ0M7QUFGRCxHQURRO0FBTXBCRSxFQUFBQSxNQU5vQixvQkFNWDtBQUNMLFNBQUtDLFFBQUwsR0FBZ0IsSUFBaEIsQ0FESyxDQUN1Qzs7QUFDNUMsU0FBS0MsVUFBTCxHQUFrQixFQUFsQixDQUZLLENBRXVDOztBQUU1QyxRQUFJQyxVQUFVLEdBQUdYLE1BQU0sQ0FBQ1ksS0FBUCxDQUFhQyxTQUFiLENBQXVCQyxNQUF4Qzs7QUFDQSxTQUFJLElBQUlDLENBQUMsR0FBRyxDQUFaLEVBQWVBLENBQUMsR0FBR0osVUFBbkIsRUFBK0JJLENBQUMsRUFBaEMsRUFBb0M7QUFDaEMsV0FBS0wsVUFBTCxDQUFnQkssQ0FBaEIsSUFBcUI7QUFBQ0MsUUFBQUEsSUFBSSxFQUFFaEIsTUFBTSxDQUFDWSxLQUFQLENBQWFDLFNBQWIsQ0FBdUJFLENBQXZCO0FBQVAsT0FBckI7QUFDSDs7QUFFRCxTQUFLRSxRQUFMLEdBQWdCLEVBQWhCO0FBQ0EsU0FBS0MsTUFBTCxHQUFjbEIsTUFBTSxDQUFDbUIsT0FBUCxDQUFlQyxPQUFmLENBQXVCLFFBQXZCLEtBQW9DO0FBQUVSLE1BQUFBLEtBQUssRUFBRSxLQUFLRixVQUFMLENBQWdCLENBQWhCLEVBQW1CTTtBQUE1QixLQUFsRDtBQUNBLFNBQUtLLEtBQUws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Q3dFLE1BQXJCLEVBQTZCQyxTQUE3QixHQUF5QyxJQUF6QztBQUNBbkQsSUFBQUEsSUFBSSxDQUFDVyxjQUFMLENBQW9CLFNBQXBCLEVBQStCRixNQUEvQixHQUF3QyxJQUF4QztBQUNILEdBbE1tQjtBQW9NcEJiLEVBQUFBLGtCQXBNb0IsZ0NBb01DO0FBQUE7O0FBQ2pCdkIsSUFBQUEsTUFBTSxDQUFDK0UsT0FBUCxDQUFlQyxRQUFmLENBQXdCLHlCQUF4QixFQUFtRDtBQUFFQyxNQUFBQSxJQUFJLEVBQUUsQ0FBUjtBQUFXQyxNQUFBQSxRQUFRLEVBQUU7QUFBckIsS0FBbkQsRUFBK0UsVUFBQ0MsS0FBRCxFQUFRQyxHQUFSLEVBQWU7QUFDMUYsTUFBQSxNQUFJLENBQUMzRSxRQUFMLEdBQWdCMkUsR0FBaEI7QUFDQSxVQUFJeEMsSUFBSSxHQUFHLE1BQUksQ0FBQ25DLFFBQUwsQ0FBY21DLElBQXpCOztBQUNBLE1BQUEsTUFBSSxDQUFDWCxjQUFMOztBQUNBLE1BQUEsTUFBSSxDQUFDVSxZQUFMOztBQUNBLE1BQUEsTUFBSSxDQUFDckIsS0FBTCxHQUFhLElBQWI7QUFDSCxLQU5EO0FBT0gsR0E1TW1CO0FBOE1wQitDLEVBQUFBLDhCQTlNb0IsMENBOE1XQyxFQTlNWCxFQThNZTtBQUMvQnRFLElBQUFBLE1BQU0sQ0FBQytFLE9BQVAsQ0FBZUMsUUFBZixDQUF3QixxQ0FBeEIsRUFBK0Q7QUFBQ1YsTUFBQUEsRUFBRSxFQUFFQTtBQUFMLEtBQS9ELEVBQXlFLFVBQUNhLEtBQUQsRUFBUUMsR0FBUixFQUFlLENBRXZGLENBRkQ7QUFHSCxHQWxObUI7QUFvTnBCQyxFQUFBQSxTQXBOb0IsdUJBb05SO0FBQ1JyRixJQUFBQSxNQUFNLENBQUNnRCxXQUFQLENBQW1Cc0MsYUFBbkI7QUFDSDtBQXRObUIsQ0FBeEIiLCJzb3VyY2VSb290IjoiLyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiDorr7nva5cclxuICovXHJcblxyXG5nbEdhbWUuYmFzZWNsYXNzLmV4dGVuZCh7XHJcbiAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgY29udGVudDogY2MuTm9kZSxcclxuICAgICAgICBpdGVtOiBjYy5Ob2RlLFxyXG4gICAgfSxcclxuXHJcbiAgICBvbkxvYWQoKSB7XHJcbiAgICAgICAgdGhpcy5uZXRNdXNpYyA9IG51bGw7ICAgICAgICAgICAgICAgICAgICAgICAvLyDnvZHnu5zpn7PkuZDliJfooahcclxuICAgICAgICB0aGlzLmxvY2FsTXVzaWMgPSBbXTsgICAgICAgICAgICAgICAgICAgICAgIC8vIOacrOWcsOmfs+S5kOWIl+ihqFxyXG5cclxuICAgICAgICBsZXQgbG9jYWxDb3VudCA9IGdsR2FtZS5hdWRpby5tdXNpY0xpc3QubGVuZ3RoO1xyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsb2NhbENvdW50OyBpKyspIHtcclxuICAgICAgICAgICAgdGhpcy5sb2NhbE11c2ljW2ldID0ge25hbWU6IGdsR2FtZS5hdWRpby5tdXNpY0xpc3RbaV19XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmF1ZGlvTWFwID0ge307XHJcbiAgICAgICAgdGhpcy5iZ05hbWUgPSBnbEdhbWUuc3RvcmFnZS5nZXRJdGVtKFwiYmdOYW1lXCIpIHx8IHsgYXVkaW86IHRoaXMubG9jYWxNdXNpY1swXS5uYW1lIH07XHJcbiAgICAgICAgdGhpcy5pbmRleCA9IDA7XHJcbiAgICAgICAgdGhpcy5iSW5pdCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucmVxQmFja2dyb3VuZE11c2ljKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIE9uQ2xpY2tUb2dnbGUoZXZlbnQpIHtcclxuICAgICAgICBpZighdGhpcy5iSW5pdCkgcmV0dXJuO1xyXG4gICAgICAgIGxldCBidXR0b25OYW1lID0gZXZlbnQubm9kZS5uYW1lO1xyXG4gICAgICAgIGxldCBidXR0b25Ob2RlID0gZXZlbnQubm9kZTtcclxuICAgICAgICBnbEdhbWUuYXVkaW8ucGxheUxvYWRTb3VuZEVmZmVjdEJ5UGF0aChcInNlbGVjdFwiKTtcclxuICAgICAgICB0aGlzLm9uQ2xpY2soYnV0dG9uTmFtZSwgYnV0dG9uTm9kZSk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uQ2xpY2sobmFtZSwgbm9kZSkge1xyXG4gICAgICAgIHN3aXRjaCAobmFtZSkge1xyXG4gICAgICAgICAgICBjYXNlIFwidG9nZ2xlXCI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsaWNrX2l0ZW1BdWRpbyhub2RlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiZG93bmxvYWRcIjpcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xpY2tfZG93bmxvYWQobm9kZSlcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgLy8g5Yid5aeL5YyW5pys5Zyw6Z+z5LmQ5YiX6KGoXHJcbiAgICBpbml0TG9jYWxNdXNpYygpIHtcclxuICAgICAgICBsZXQgbG9jYWxNdXNpYyA9IHRoaXMubG9jYWxNdXNpYztcclxuICAgICAgICBsZXQgY291bnQgPSBsb2NhbE11c2ljLmxlbmd0aDtcclxuXHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcclxuICAgICAgICAgICAgbGV0IGl0ZW0gPSBjYy5pbnN0YW50aWF0ZSh0aGlzLml0ZW0pO1xyXG4gICAgICAgICAgICBpdGVtLmFjdGl2ZSA9IHRydWU7XHJcbiAgICAgICAgICAgIGl0ZW0uaW5kZXggPSBpO1xyXG4gICAgICAgICAgICBpdGVtLnBhcmVudCA9IHRoaXMuY29udGVudDtcclxuICAgICAgICAgICAgaXRlbS5nZXRDaGlsZEJ5TmFtZShcInRpdGxlXCIpLmdldENvbXBvbmVudChjYy5MYWJlbCkuc3RyaW5nID0gbG9jYWxNdXNpY1tpXS5uYW1lO1xyXG4gICAgICAgICAgICBpdGVtLmdldENoaWxkQnlOYW1lKFwiZG93bmxvYWRcIikuYWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGl0ZW0uZ2V0Q2hpbGRCeU5hbWUoXCJkb3dubG9hZFwiKS5pbmRleCA9IGk7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuYmdOYW1lLmF1ZGlvID09IGxvY2FsTXVzaWNbaV0ubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRUb2dnbGUoaXRlbSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmluZGV4ID0gaTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5hdWRpb01hcFtsb2NhbE11c2ljW2ldLm5hbWVdID0ge25hbWU6IGxvY2FsTXVzaWNbaV0sIG5vZGU6IGl0ZW19O1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgLy8g5Yid5aeL5YyW572R57uc6Z+z5LmQ5YiX6KGoXHJcbiAgICBpbml0TmV0TXVzaWMoKSB7XHJcbiAgICAgICAgbGV0IG5ldE11c2ljID0gdGhpcy5uZXRNdXNpYy5kYXRhO1xyXG4gICAgICAgIGxldCBsb2NhbENvdW50ID0gdGhpcy5sb2NhbE11c2ljLmxlbmd0aDtcclxuICAgICAgICBsZXQgY291bnQgPSBuZXRNdXNpYy5sZW5ndGg7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xyXG4gICAgICAgICAgICBsZXQgaXRlbSA9IGNjLmluc3RhbnRpYXRlKHRoaXMuaXRlbSk7XHJcbiAgICAgICAgICAgIGl0ZW0uYWN0aXZlID0gdHJ1ZTtcclxuICAgICAgICAgICAgaXRlbS5pbmRleCA9IGxvY2FsQ291bnQgKyBpO1xyXG4gICAgICAgICAgICBpdGVtLnBhcmVudCA9IHRoaXMuY29udGVudDtcclxuICAgICAgICAgICAgaXRlbS5nZXRDaGlsZEJ5TmFtZShcInRpdGxlXCIpLmdldENvbXBvbmVudChjYy5MYWJlbCkuc3RyaW5nID0gbmV0TXVzaWNbaV0ubmFtZTsgXHJcbiAgICAgICAgICAgIGl0ZW0uZ2V0Q2hpbGRCeU5hbWUoXCJkb3dubG9hZFwiKS5pbmRleCA9IGxvY2FsQ291bnQgKyBpO1xyXG5cclxuICAgICAgICAgICAgbGV0IHVybCA9IG5ldE11c2ljW2ldLnVybDtcclxuICAgICAgICAgICAgaWYodGhpcy5iZ05hbWUuYXVkaW8gPT0gdXJsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldFRvZ2dsZShpdGVtKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5kZXggPSBsb2NhbENvdW50ICsgaTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYoY2Muc3lzLmlzTmF0aXZlKSB7XHJcbiAgICAgICAgICAgICAgICBpZighZ2xHYW1lLmF1ZGlvbG9hZGVyLmlzTG9hZGVkKHVybCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihnbEdhbWUuYXVkaW9sb2FkZXIuaXNMb2FkaW5nKHVybCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRQZXJjZW50KHVybCwgZ2xHYW1lLmF1ZGlvbG9hZGVyLmdldFBlcmNlbnQodXJsKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsR2FtZS5hdWRpb2xvYWRlci5sb2FkQXVkaW8odXJsLCB0aGlzLm9uTG9hZFByb2dyZXNzLmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uZ2V0Q2hpbGRCeU5hbWUoXCJkb3dubG9hZFwiKS5hY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5hdWRpb01hcFtuZXRNdXNpY1tpXS51cmxdID0ge2RhdGE6IG5ldE11c2ljW2ldLCBub2RlOiBpdGVtfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBhbGxMZW5ndGggPSBsb2NhbENvdW50ICsgY291bnQ7XHJcbiAgICAgICAgbGV0IGhlaWdodCA9IE1hdGguY2VpbChhbGxMZW5ndGggLyAyKSAqIDEyODtcclxuICAgICAgICB0aGlzLmNvbnRlbnQuaGVpZ2h0ID0gaGVpZ2h0O1xyXG4gICAgICAgIGxldCBzY29ybGx2aWV3ID0gdGhpcy5ub2RlLmdldENoaWxkQnlOYW1lKFwic2Nyb2xsdmlld1wiKS5nZXRDb21wb25lbnQoY2MuU2Nyb2xsVmlldyk7XHJcbiAgICAgICAgc2Nvcmxsdmlldy5zY3JvbGxUb1RvcCgpO1xyXG4gICAgfSxcclxuXHJcbiAgICBjbGlja19pdGVtQXVkaW8obm9kZSkge1xyXG4gICAgICAgIGlmKCF0aGlzLmJJbml0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBsb2NhbENvdW50ID0gdGhpcy5sb2NhbE11c2ljLmxlbmd0aDtcclxuICAgICAgICBsZXQgbXVzaWNMaXN0ID0gdGhpcy5uZXRNdXNpYy5kYXRhO1xyXG4gICAgICAgIGxldCBpbmRleCA9IG5vZGUuaW5kZXg7IFxyXG4gICAgICAgIHRoaXMuaW5kZXggPSBpbmRleDtcclxuXHJcbiAgICAgICAgdGhpcy5oaWRlQWxsU3BpbmUoKTtcclxuICAgICAgICBub2RlLmdldENoaWxkQnlOYW1lKFwic3BfcGxheVwiKS5hY3RpdmUgPSB0cnVlO1xyXG5cclxuICAgICAgICBpZihpbmRleCA8IGxvY2FsQ291bnQpIHtcclxuICAgICAgICAgICAgZ2xHYW1lLnN0b3JhZ2Uuc2V0SXRlbShcImJnTmFtZVwiLCB7YXVkaW86IHRoaXMubG9jYWxNdXNpY1tpbmRleF0ubmFtZX0pO1xyXG4gICAgICAgICAgICBnbEdhbWUuYXVkaW8ucGxheVBhdGhCR00oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgdXJsID0gbXVzaWNMaXN0W25vZGUuaW5kZXggLSBsb2NhbENvdW50XS51cmw7XHJcbiAgICAgICAgICAgIGdsR2FtZS5hdWRpb2xvYWRlci5sb2FkQXVkaW8odXJsLCB0aGlzLm9uTG9hZFByb2dyZXNzLmJpbmQodGhpcykpLnRoZW4oKGF1ZGlvQ2xpcCk9PiB7XHJcbiAgICAgICAgICAgICAgICBpZih0aGlzLmluZGV4ICE9IGluZGV4KSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICBnbEdhbWUuc3RvcmFnZS5zZXRJdGVtKFwiYmdOYW1lXCIsIHthdWRpbzogdXJsLCBuZXRNdXNpYzogdHJ1ZX0pXHJcbiAgICAgICAgICAgICAgICBnbEdhbWUuYXVkaW8ucGxheUJHTShhdWRpb0NsaXApO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG5cclxuICAgICAgICAgICAgaWYoY2Muc3lzLmlzTmF0aXZlKSB7XHJcbiAgICAgICAgICAgICAgICBpZighZ2xHYW1lLmF1ZGlvbG9hZGVyLmlzTG9hZGVkKHVybCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBub2RlLmdldENoaWxkQnlOYW1lKFwicHJvY2Vzc1wiKS5hY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIG5vZGUuZ2V0Q2hpbGRCeU5hbWUoXCJkb3dubG9hZFwiKS5hY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgY2xpY2tfZG93bmxvYWQobm9kZSkge1xyXG4gICAgICAgIGxldCBsb2NhbENvdW50ID0gdGhpcy5sb2NhbE11c2ljLmxlbmd0aDtcclxuICAgICAgICBsZXQgbXVzaWNMaXN0ID0gdGhpcy5uZXRNdXNpYy5kYXRhO1xyXG4gICAgICAgIGxldCBpbmRleCA9IG5vZGUuaW5kZXggLSBsb2NhbENvdW50O1xyXG5cclxuICAgICAgICBsZXQgdXJsID0gbXVzaWNMaXN0W2luZGV4XS51cmw7XHJcblxyXG4gICAgICAgIGlmKGdsR2FtZS5hdWRpb2xvYWRlci5pc0xvYWRlZCh1cmwpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKGdsR2FtZS5hdWRpb2xvYWRlci5pc0xvYWRpbmcodXJsKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBub2RlLmdldENoaWxkQnlOYW1lKFwiQmFja2dyb3VuZFwiKS5hY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICBnbEdhbWUuYXVkaW9sb2FkZXIubG9hZEF1ZGlvKHVybCwgdGhpcy5vbkxvYWRQcm9ncmVzcy5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLnJlcUJhY2tncm91bmRNdXNpY0Rvd25sb2Fkc0luYyhtdXNpY0xpc3RbaW5kZXhdLmlkKTtcclxuICAgIH0sXHJcblxyXG4gICAgaGlkZUFsbFNwaW5lKCkge1xyXG4gICAgICAgIGZvcihsZXQgayBpbiB0aGlzLmF1ZGlvTWFwKSB7XHJcbiAgICAgICAgICAgIGxldCBpdGVtID0gdGhpcy5hdWRpb01hcFtrXTtcclxuICAgICAgICAgICAgaXRlbS5ub2RlLmdldENoaWxkQnlOYW1lKFwic3BfcGxheVwiKS5hY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIOmfs+S5kOS4i+i9vei/m+W6plxyXG4gICAgb25Mb2FkUHJvZ3Jlc3ModXJsLCBwZXJjZW50KSB7XHJcbiAgICAgICAgdGhpcy5zZXRQZXJjZW50KHVybCwgcGVyY2VudCk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIOiuvue9rueZvuWIhuavlFxyXG4gICAgc2V0UGVyY2VudCh1cmwsIHBlcmNlbnQpIHtcclxuICAgICAgICBsZXQgaW5mbyA9IHRoaXMuYXVkaW9NYXBbdXJsXTtcclxuICAgICAgICBpZighaW5mbykgcmV0dXJuO1xyXG4gICAgICAgIGxldCBub2RlID0gaW5mby5ub2RlO1xyXG4gICAgICAgIGxldCBwcm9ncmVzcyA9IG5vZGUuZ2V0Q2hpbGRCeU5hbWUoXCJwcm9jZXNzXCIpO1xyXG4gICAgICAgIGxldCBkb3dubG9hZCA9IG5vZGUuZ2V0Q2hpbGRCeU5hbWUoXCJkb3dubG9hZFwiKTtcclxuXHJcbiAgICAgICAgaWYocGVyY2VudCA9PSAxMDApIHtcclxuICAgICAgICAgICAgcHJvZ3Jlc3MuYWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGRvd25sb2FkLmFjdGl2ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcm9ncmVzcy5hY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgIHByb2dyZXNzLmdldENoaWxkQnlOYW1lKFwicHJvXCIpLmdldENvbXBvbmVudChjYy5Qcm9ncmVzc0JhcikucHJvZ3Jlc3MgPSBwZXJjZW50IC8gMTAwO1xyXG4gICAgICAgIHByb2dyZXNzLmdldENoaWxkQnlOYW1lKFwibGFiZWxcIikuZ2V0Q29tcG9uZW50KGNjLkxhYmVsKS5zdHJpbmcgPSBgJHtwZXJjZW50fSVgO1xyXG4gICAgfSxcclxuXHJcbiAgICBzZXRUb2dnbGUobm9kZSkge1xyXG4gICAgICAgIG5vZGUuZ2V0Q29tcG9uZW50KGNjLlRvZ2dsZSkuaXNDaGVja2VkID0gdHJ1ZTtcclxuICAgICAgICBub2RlLmdldENoaWxkQnlOYW1lKFwic3BfcGxheVwiKS5hY3RpdmUgPSB0cnVlO1xyXG4gICAgfSxcclxuXHJcbiAgICByZXFCYWNrZ3JvdW5kTXVzaWMoKSB7XHJcbiAgICAgICAgZ2xHYW1lLmdhbWVOZXQuc2VuZF9tc2coJ2h0dHAuUmVxQmFja2dyb3VuZE11c2ljJywgeyBwYWdlOiAxLCBwYWdlU2l6ZTogMTAwIH0sIChyb3V0ZSwgbXNnKT0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZXRNdXNpYyA9IG1zZztcclxuICAgICAgICAgICAgbGV0IGRhdGEgPSB0aGlzLm5ldE11c2ljLmRhdGE7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdExvY2FsTXVzaWMoKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0TmV0TXVzaWMoKTtcclxuICAgICAgICAgICAgdGhpcy5iSW5pdCA9IHRydWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIHJlcUJhY2tncm91bmRNdXNpY0Rvd25sb2Fkc0luYyhpZCkge1xyXG4gICAgICAgIGdsR2FtZS5nYW1lTmV0LnNlbmRfbXNnKCdodHRwLlJlcUJhY2tncm91bmRNdXNpY0Rvd25sb2Fkc0luYycsIHtpZDogaWR9LCAocm91dGUsIG1zZyk9PiB7XHJcblxyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgZ2xHYW1lLmF1ZGlvbG9hZGVyLmNsZWFyQ2FsbGJhY2soKTtcclxuICAgIH0sXHJcbn0pO1xyXG4iXX0=